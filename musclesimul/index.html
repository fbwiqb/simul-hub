<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¼ìœ¡ ìˆ˜ì¶• ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #3d4e9f;
            --primary-dark: #2c3a7a;
            --primary-light: #5068c4;
            --primary-gradient: linear-gradient(135deg, #3d4e9f 0%, #5068c4 100%);
            --primary-gradient-hover: linear-gradient(135deg, #2c3a7a 0%, #3d4e9f 100%);
            --accent-green: #28a745;
            --accent-green-light: #48c774;
            --accent-green-dark: #218838;
            --accent-red: #dc3545;
            --accent-red-light: #e85d6a;
            --accent-red-dark: #c82333;
            --accent-orange: #fd7e14;
            --accent-orange-light: #fdab6c;
            --accent-orange-dark: #e8590c;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-body: #333;
            --bg-body: linear-gradient(135deg, #f8f9ff 0%, #eef0f8 100%);
            --bg-card: #fff;
            --bg-light: #f8f9fa;
            --bg-input: #f1f3f5;
            --border: #dee2e6;
            --border-blue: #0066cc;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 2px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-modal: 0 20px 60px rgba(0,0,0,0.4);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 20px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
            background: var(--bg-body);
            min-height: 100vh;
            padding: 10px;
            transition: background 0.3s ease;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 10px; width: 100%; }
        header { text-align: center; margin-bottom: 10px; }
        header h1 {
            font-size: 22px; color: var(--text-primary);
            display: inline-flex; align-items: center; gap: 8px;
        }
        .version-badge {
            display: inline-block; background: var(--primary-gradient);
            color: white; font-size: 11px; font-weight: 700;
            padding: 2px 8px; border-radius: 10px; vertical-align: middle;
        }
        .control-panel {
            background: var(--bg-card); padding: 10px;
            border-radius: var(--radius-md); margin-bottom: 10px;
            box-shadow: var(--shadow-md); transition: box-shadow 0.3s ease;
        }
        .control-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; flex-wrap: wrap; gap: 8px;
        }
        .control-row:last-child { margin-bottom: 0; }
        .control-group { display: flex; align-items: center; gap: 10px; }
        label { font-weight: 600; font-size: 16px; }
        .length-value { color: var(--primary); font-size: 20px; font-weight: bold; min-width: 100px; }
        .delta-display { color: var(--text-secondary); font-size: 15px; }
        select {
            padding: 8px 12px; border: 2px solid var(--border);
            border-radius: var(--radius-sm); font-size: 15px;
            background: white; cursor: pointer; font-weight: 600; transition: all 0.2s ease;
        }
        select:hover { border-color: var(--primary); }
        select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(61,78,159,0.1); }
        input[type="range"] {
            flex: 1; min-width: 200px; height: 8px;
            -webkit-appearance: none; appearance: none;
            background: var(--border); border-radius: 5px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 32px; height: 32px; background: var(--primary);
            border-radius: 50%; cursor: pointer;
            box-shadow: 0 2px 6px rgba(61,78,159,0.3); transition: all 0.2s ease;
        }
        input[type="range"]::-moz-range-thumb {
            width: 32px; height: 32px; background: var(--primary);
            border-radius: 50%; cursor: pointer; border: none;
            box-shadow: 0 2px 6px rgba(61,78,159,0.3); transition: all 0.2s ease;
        }
        @media (hover: hover) {
            input[type="range"]::-webkit-slider-thumb:hover {
                background: var(--primary-dark);
                box-shadow: 0 3px 10px rgba(61,78,159,0.5); transform: scale(1.15);
            }
            input[type="range"]::-moz-range-thumb:hover {
                background: var(--primary-dark);
                box-shadow: 0 3px 10px rgba(61,78,159,0.5); transform: scale(1.15);
            }
        }
        .slider-value { font-size: 18px; font-weight: bold; color: var(--primary); min-width: 80px; text-align: center; }
        button {
            padding: 10px 25px; font-size: 16px; border-radius: var(--radius-md);
            border: none; cursor: pointer; font-weight: 600;
            transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        @media (hover: hover) {
            button:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
        }
        button:active { transform: translateY(0); box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-reset { background: linear-gradient(135deg, var(--accent-red) 0%, var(--accent-red-light) 100%); color: white; }
        .btn-play { background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-light) 100%); color: white; min-width: 120px; }
        .btn-play.playing { background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-orange-light) 100%); }
        .btn-capture { background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-green-light) 100%); color: white; padding: 8px 20px; font-size: 14px; }
        .btn-screenshot { background: var(--primary-gradient); color: white; padding: 8px 20px; font-size: 14px; }
        @media (hover: hover) {
            .btn-primary:hover { background: var(--primary-gradient-hover); }
            .btn-reset:hover { background: linear-gradient(135deg, var(--accent-red-dark) 0%, var(--accent-red) 100%); }
            .btn-play:hover { background: linear-gradient(135deg, var(--accent-green-dark) 0%, var(--accent-green) 100%); }
            .btn-play.playing:hover { background: linear-gradient(135deg, var(--accent-orange-dark) 0%, var(--accent-orange) 100%); }
            .btn-capture:hover { background: linear-gradient(135deg, var(--accent-green-dark) 0%, var(--accent-green) 100%); }
            .btn-screenshot:hover { background: var(--primary-gradient-hover); }
        }
        .checkbox-group { display: flex; gap: 15px; align-items: center; }
        .checkbox-group label { cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 5px; }
        .svg-container {
            background: linear-gradient(135deg, #e7f3ff 0%, #d4ebff 100%);
            border: 2px solid var(--border-blue); border-radius: var(--radius-md);
            padding: 8px; margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,102,204,0.1); transition: box-shadow 0.3s ease;
        }
        #muscleSvg { display: block; margin: 0 auto; max-width: 100%; height: auto; }
        .graph-section { margin-bottom: 10px; }
        .graph-box {
            background: var(--bg-card); border-radius: var(--radius-md);
            padding: 8px; box-shadow: var(--shadow-sm); transition: all 0.3s ease;
        }
        .graph-box.graph-hidden { display: none; }
        .graph-box h3 { text-align: center; margin-bottom: 4px; font-size: 14px; padding-bottom: 4px; border-bottom: 3px solid var(--primary); }
        .graph-box canvas { width: 100% !important; height: auto !important; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        .info-card {
            background: var(--bg-card); padding: 12px;
            border-radius: var(--radius-md); box-shadow: var(--shadow-sm); transition: all 0.3s ease;
        }
        .info-card h4 { font-size: 14px; margin-bottom: 8px; color: var(--text-primary); border-bottom: 2px solid var(--primary); padding-bottom: 6px; }
        .info-card ul { list-style: none; padding: 0; }
        .info-card li { padding: 4px 0; font-size: 13px; border-bottom: 1px solid #f0f0f0; }
        .info-card li:last-child { border-bottom: none; }
        .delta-positive { color: var(--accent-green); }
        .delta-negative { color: var(--accent-red); }
        .delta-info { color: var(--primary); }
        .data-table-container {
            border: 2px solid var(--border); background-color: var(--bg-card);
            padding: 8px; border-radius: var(--radius-sm);
            box-shadow: var(--shadow-sm); margin-bottom: 10px; transition: box-shadow 0.3s ease;
        }
        .data-table-container h4 {
            margin-top: 0; text-align: center; font-size: 13px; margin-bottom: 6px;
            color: var(--text-primary); display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { border: 2px solid var(--border); padding: 5px 8px; text-align: center; }
        .data-table th { background-color: #e9ecef; font-weight: 600; font-size: 12px; }
        .data-table th span { font-size: 9px; font-weight: 400; color: var(--text-secondary); }
        .data-table td { font-size: 13px; font-weight: 500; }
        .data-table td.label-cell { font-weight: bold; background-color: var(--bg-light); font-size: 12px; }
        .data-table td.value-cell { background-color: white; color: #212529; }
        .live-row td.value-cell { font-weight: bold; }
        .delete-btn {
            background: linear-gradient(135deg, var(--accent-red) 0%, var(--accent-red-light) 100%);
            color: white; border: none; padding: 2px 6px; border-radius: 3px;
            cursor: pointer; font-size: 11px; transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(220,53,69,0.3);
        }
        .calculator-section {
            background: var(--bg-card); padding: 12px; border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm); margin-bottom: 10px; transition: box-shadow 0.3s ease;
        }
        .calculator-section h4 { font-size: 14px; margin-bottom: 8px; color: var(--text-primary); border-bottom: 2px solid var(--primary); padding-bottom: 6px; }
        .calc-table { width: 100%; border-collapse: collapse; background: white; }
        .calc-table th, .calc-table td { border: 2px solid var(--border); padding: 6px 8px; text-align: center; }
        .calc-table th { background-color: #e9ecef; font-weight: 600; font-size: 12px; }
        .calc-table td { font-size: 13px; }
        .calc-table select { width: 100%; padding: 6px; border: 2px solid var(--border); border-radius: 4px; font-size: 13px; }
        .calc-table .operator-select { font-size: 16px; font-weight: bold; text-align: center; background: var(--bg-light); }
        .calc-table td:nth-child(4) { font-weight: bold; }
        .footer {
            background: var(--primary); color: white; text-align: center;
            padding: 10px 20px; font-size: 14px; margin-top: 20px;
        }
        .footer a { color: white; text-decoration: none; }
        @media (hover: hover) { .footer a:hover { text-decoration: underline; } }
        .modal {
            display: none; position: fixed; z-index: 1000;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); overflow-y: auto;
        }
        .modal-content {
            background-color: white; margin: 5% auto; padding: 30px;
            border-radius: var(--radius-lg); width: 90%; max-width: 700px;
            max-height: 85vh; overflow-y: auto;
            box-shadow: var(--shadow-modal); animation: modalSlideIn 0.3s ease;
        }
        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            background: linear-gradient(135deg, #3d4e9f 0%, #667eea 100%);
            color: white; padding: 20px; margin: -30px -30px 20px -30px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { color: white; margin: 0; font-size: 24px; }
        .modal-close {
            background: none; color: white; border: none; font-size: 30px;
            cursor: pointer; padding: 0; width: 35px; height: 35px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; transition: all 0.3s; box-shadow: none;
        }
        @media (hover: hover) { .modal-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg) scale(1.1); } }
        .modal-body { padding: 10px; color: var(--text-body); line-height: 1.8; }
        .help-section {
            margin-bottom: 25px; padding: 20px; background: var(--bg-light);
            border-radius: 10px; border-left: 4px solid var(--primary); transition: all 0.2s ease;
        }
        .help-section h3 { color: var(--primary); margin-bottom: 10px; font-size: 18px; }
        .help-section p, .help-section ul { margin: 10px 0; }
        .help-section ul { padding-left: 25px; }
        .help-section li { margin: 8px 0; }
        .help-section strong { color: var(--primary); }
        .log-date { color: var(--primary); font-weight: bold; font-size: 1.1em; margin-bottom: 10px; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header h1 { font-size: 18px; }
            .control-row { flex-direction: column; gap: 10px; align-items: stretch; }
            .control-group { flex-wrap: wrap; justify-content: center; }
            .info-grid { grid-template-columns: 1fr; }
            .modal-content { width: 95%; margin: 10% auto; padding: 20px; }
            .modal-header { margin: -20px -20px 15px -20px; padding: 15px; }
            .modal-header h2 { font-size: 18px; }
            button { padding: 8px 16px; font-size: 14px; }
            .data-table th, .data-table td { padding: 4px 4px; font-size: 11px; }
        }
        @media (max-width: 480px) {
            .control-group { gap: 6px; }
            button { padding: 8px 12px; font-size: 13px; }
            .checkbox-group { flex-wrap: wrap; gap: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ”¬ ê·¼ìœ¡ ìˆ˜ì¶• ì‹œë®¬ë ˆì´í„° <span class="version-badge">v2.0</span></h1>
        </header>
        <main>
            <section class="control-panel" aria-label="ì‹œë®¬ë ˆì´í„° ì»¨íŠ¸ë¡¤">
                <div class="control-row">
                    <div class="control-group">
                        <label>ê·¼ì ˆ ê¸¸ì´: <span id="lengthDisplay" class="length-value">2.40 Î¼m</span> <span id="deltaDisplay" class="delta-display">(ê¸°ì¤€ê°’)</span></label>
                    </div>
                    <div class="control-group">
                        <button class="btn-reset" id="resetBtn">ğŸ”„ ì´ˆê¸°í™”</button>
                        <button class="btn-primary" id="theoryBtn">ğŸ“– ì´ë¡  ì„¤ëª…</button>
                        <button class="btn-primary" id="devLogBtn">ğŸ“ ê°œë°œì ë¡œê·¸</button>
                        <button class="btn-primary" id="helpBtn">â“ ì‚¬ìš©ë²•</button>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group" style="flex: 1;">
                        <label>â±ï¸ ìˆ˜ì¶• ì¡°ì ˆ:</label>
                        <button class="btn-play" id="playBtn">â–¶ ì¬ìƒ</button>
                        <select id="speedSelect">
                            <option value="slow">ëŠë¦¼</option>
                            <option value="normal" selected>ë³´í†µ</option>
                            <option value="fast">ë¹ ë¦„</option>
                        </select>
                        <input type="range" id="sarcomereSlider" min="0" max="16" value="4" step="1" aria-label="ê·¼ì ˆ ê¸¸ì´ ìŠ¬ë¼ì´ë”">
                        <span class="slider-value" id="sliderValue">2.40 Î¼m</span>
                    </div>
                </div>
                <div class="control-row">
                    <div class="checkbox-group">
                        <span style="font-weight: 600;">ğŸ“Š í‘œì‹œ ì˜µì…˜:</span>
                        <label><input type="checkbox" id="graphToggle" checked> ì¥ë ¥ ê·¸ë˜í”„</label>
                    </div>
                </div>
            </section>

            <section class="svg-container" aria-label="ê·¼ì ˆ êµ¬ì¡° ì‹œê°í™”">
                <svg id="muscleSvg" viewBox="0 0 800 320" preserveAspectRatio="xMidYMid meet" aria-label="ê·¼ìœ¡ ìˆ˜ì¶• ì‹œë®¬ë ˆì´ì…˜ ë‹¤ì´ì–´ê·¸ë¨"></svg>
            </section>

            <section class="graph-section" aria-label="ì¥ë ¥-ê¸¸ì´ ê·¸ë˜í”„">
                <div class="graph-box" id="forceGraph">
                    <h3>ğŸ’ª ì¥ë ¥-ê¸¸ì´ ê´€ê³„ ê·¸ë˜í”„</h3>
                    <canvas id="forceChart"></canvas>
                </div>
            </section>

            <section class="info-grid" aria-label="ê¸¸ì´ ì •ë³´">
                <div class="info-card">
                    <h4>ğŸ“ í˜„ì¬ ê¸¸ì´ ì •ë³´</h4>
                    <ul id="lengthList"></ul>
                </div>
                <div class="info-card">
                    <h4>ğŸ“Š ê¸¸ì´ ë³€í™” (ê¸°ì¤€ê°’ ëŒ€ë¹„)</h4>
                    <ul id="changesList"></ul>
                </div>
            </section>

            <section class="data-table-container" aria-label="ê¸¸ì´ ë°ì´í„° ê¸°ë¡">
                <h4>ğŸ“‹ ê¸¸ì´ ë°ì´í„° ê¸°ë¡
                    <button class="btn-capture" id="captureBtn">ğŸ“¸ ìº¡ì²˜</button>
                    <button class="btn-screenshot" id="screenshotBtn">ğŸ“· ìŠ¤í¬ë¦°ìƒ·</button>
                </h4>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ê·¼ì ˆ <span>(Î¼m)</span></th>
                            <th>AëŒ€ <span>(Î¼m)</span></th>
                            <th>IëŒ€ <span>(Î¼m)</span></th>
                            <th>HëŒ€ <span>(Î¼m)</span></th>
                            <th>ê²¹ì¹˜ëŠ” êµ¬ê°„ <span>(Î¼m)</span></th>
                            <th>ìƒëŒ€ ì¥ë ¥ <span>(%)</span></th>
                            <th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
            </section>

            <section class="calculator-section" aria-label="ê¸¸ì´ ê³„ì‚°ê¸°">
                <h4>ğŸ§® ê¸¸ì´ ê³„ì‚°ê¸°</h4>
                <table class="calc-table">
                    <thead>
                        <tr><th>ì„ íƒ 1</th><th>ì—°ì‚°ì</th><th>ì„ íƒ 2</th><th>ê²°ê³¼</th></tr>
                    </thead>
                    <tbody id="calculatorTable"></tbody>
                </table>
            </section>
        </main>
    </div>

    <footer class="footer">
        â“’ 2025-2026 ì¶©ë‚¨ì‚¼ì„±ê³ ë“±í•™êµ ì‹ ë„ê²½T<br>
        <a href="mailto:pantarei01@cnsa.hs.kr">pantarei01@cnsa.hs.kr</a>
    </footer>

    <div class="modal" id="theoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“– ìŠ¬ë¼ì´ë”© í•„ë¼ë©˜íŠ¸ ì´ë¡ </h2>
                <button class="modal-close" id="theoryClose" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>ğŸ”¬ ê¸°ë³¸ ì›ë¦¬</h3>
                    <p>ê·¼ìœ¡ ìˆ˜ì¶• ì‹œ <strong>ì•¡í‹´(ê°€ëŠ” í•„ë¼ë©˜íŠ¸)</strong>ì´ <strong>ë§ˆì´ì˜¤ì‹ (êµµì€ í•„ë¼ë©˜íŠ¸)</strong> ì‚¬ì´ë¡œ ë¯¸ë„ëŸ¬ì ¸ ë“¤ì–´ê°€ë©´ì„œ ê·¼ì ˆ(sarcomere)ì˜ ê¸¸ì´ê°€ ì§§ì•„ì§‘ë‹ˆë‹¤.</p>
                </div>
                <div class="help-section">
                    <h3>ğŸ—ï¸ ì£¼ìš” êµ¬ì¡°</h3>
                    <ul>
                        <li><strong>Zì„ </strong>: ê·¼ì ˆì˜ ì–‘ ë ê²½ê³„</li>
                        <li><strong>Mì„ </strong>: ê·¼ì ˆì˜ ì •ì¤‘ì•™, ë§ˆì´ì˜¤ì‹ ì˜ ì¤‘ì‹¬</li>
                        <li><strong>AëŒ€</strong>: ë§ˆì´ì˜¤ì‹  í•„ë¼ë©˜íŠ¸ê°€ ìˆëŠ” ì˜ì—­ (1.6 Î¼m, ì¼ì •)</li>
                        <li><strong>IëŒ€</strong>: ì•¡í‹´ë§Œ ìˆëŠ” ì˜ì—­ (ìˆ˜ì¶• ì‹œ ê°ì†Œ)</li>
                        <li><strong>HëŒ€</strong>: ë§ˆì´ì˜¤ì‹ ë§Œ ìˆëŠ” ì˜ì—­ (ìˆ˜ì¶• ì‹œ ê°ì†Œ)</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>ğŸ“ ìˆ˜ì¹˜ ì •ë³´</h3>
                    <ul>
                        <li><strong>ë§ˆì´ì˜¤ì‹  ê¸¸ì´</strong>: 1.6 Î¼m (ì¼ì •)</li>
                        <li><strong>ì•¡í‹´ ê¸¸ì´</strong>: 1.0 Î¼m (ì¼ì •)</li>
                        <li><strong>AëŒ€</strong> = ë§ˆì´ì˜¤ì‹  ê¸¸ì´ = 1.6 Î¼m (ì¼ì •)</li>
                        <li><strong>IëŒ€</strong> = ê·¼ì ˆ - AëŒ€ = ê·¼ì ˆ - 1.6 Î¼m</li>
                        <li><strong>HëŒ€</strong> = ê·¼ì ˆ - 2 Ã— ì•¡í‹´ (= AëŒ€ - ê²¹ì¹˜ëŠ” êµ¬ê°„)</li>
                        <li><strong>Â½ IëŒ€ + Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„</strong> = ì•¡í‹´ ê¸¸ì´ (í•­ìƒ 1.0)</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>ğŸ’ª ì¥ë ¥-ê¸¸ì´ ê´€ê³„</h3>
                    <ul>
                        <li><strong>2.0~2.2 Î¼m</strong>: ìµœëŒ€ ì¥ë ¥ (100%) - ìµœì  ê²¹ì¹¨</li>
                        <li><strong>2.2~3.6 Î¼m</strong>: ì¥ë ¥ ê°ì†Œ - ê²¹ì¹¨ êµ¬ê°„ ê°ì†Œ</li>
                        <li><strong>3.6 Î¼m ì´ìƒ</strong>: ì¥ë ¥ 0% - ê²¹ì¹¨ ì—†ìŒ</li>
                        <li><strong>2.0 Î¼m ë¯¸ë§Œ</strong>: ì¥ë ¥ ê°ì†Œ - ê³¼ë„í•œ ê²¹ì¹¨ìœ¼ë¡œ ê°„ì„­</li>
                    </ul>
                </div>
                <div class="help-section">
                    <h3>ğŸ“Š ìˆ˜ì¶• ì‹œ ë³€í™” ìš”ì•½</h3>
                    <ul>
                        <li>ê·¼ì ˆ ê¸¸ì´ â†“ (Zì„  ê°„ ê±°ë¦¬ ê°ì†Œ)</li>
                        <li>IëŒ€ ê¸¸ì´ â†“</li>
                        <li>HëŒ€ ê¸¸ì´ â†“</li>
                        <li>AëŒ€ ê¸¸ì´ = ì¼ì •</li>
                        <li>ì•¡í‹´-ë§ˆì´ì˜¤ì‹  ê²¹ì¹˜ëŠ” êµ¬ê°„ â†‘</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â“ ì‚¬ìš©ë²•</h2>
                <button class="modal-close" id="helpClose" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <h3>ğŸ® ê¸°ë³¸ ì‚¬ìš©ë²•</h3>
                    <p><strong>1. ìŠ¬ë¼ì´ë” ì¡°ì‘</strong></p>
                    <ul>
                        <li>ìŠ¬ë¼ì´ë”ë¥¼ ì¢Œìš°ë¡œ ì›€ì§ì—¬ ê·¼ì ˆì˜ ê¸¸ì´ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤ (2.0~3.6 Î¼m)</li>
                        <li>ì¢Œì¸¡: ìµœëŒ€ ìˆ˜ì¶• (2.0 Î¼m) / ìš°ì¸¡: ì´ì™„ (3.6 Î¼m)</li>
                    </ul>
                    <p><strong>2. ì¬ìƒ ê¸°ëŠ¥</strong></p>
                    <ul>
                        <li><strong>â–¶ ì¬ìƒ</strong>: ìë™ìœ¼ë¡œ ìˆ˜ì¶•/ì´ì™„ ì• ë‹ˆë©”ì´ì…˜</li>
                        <li>ì†ë„ ì„ íƒ: ëŠë¦¼, ë³´í†µ, ë¹ ë¦„</li>
                    </ul>
                    <p><strong>3. ë°ì´í„° ìº¡ì²˜</strong></p>
                    <ul>
                        <li>ğŸ“¸ ìº¡ì²˜: í˜„ì¬ ê¸¸ì´ ë°ì´í„°ë¥¼ í‘œì— ê¸°ë¡</li>
                        <li>ğŸ“· ìŠ¤í¬ë¦°ìƒ·: í˜„ì¬ í™”ë©´ì„ ì´ë¯¸ì§€ë¡œ ì €ì¥</li>
                    </ul>
                    <p><strong>4. ê³„ì‚°ê¸°</strong></p>
                    <ul>
                        <li>ë“œë¡­ë‹¤ìš´ì—ì„œ ë‘ ê°’ì„ ì„ íƒí•˜ê³  ì—°ì‚°ìë¥¼ ì ìš©í•˜ì—¬ ê´€ê³„ì‹ ê²€ì¦</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="devLogModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ“ ê°œë°œì ë¡œê·¸</h2>
                <button class="modal-close" id="devLogClose" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-section">
                    <div class="log-date">2026. 2. 24. (ì›”)</div>
                    <strong>v2.0 ì „ë©´ ì—…ë°ì´íŠ¸</strong><br>
                    - ğŸ“ ìˆ˜ì¹˜ ë³´ì •: ë§ˆì´ì˜¤ì‹  1.6 Î¼m, ì•¡í‹´ 1.0 Î¼m, ê·¼ì ˆ 2.0~3.6 Î¼m<br>
                    - ğŸ’ª ì¥ë ¥-ê¸¸ì´ ê´€ê³„ ê·¸ë˜í”„ ì¶”ê°€ (Chart.js)<br>
                    - â–¶ï¸ ì¬ìƒ/ì¼ì‹œì •ì§€ ì• ë‹ˆë©”ì´ì…˜ + ì†ë„ ì¡°ì ˆ<br>
                    - ğŸ“¸ ë°ì´í„° ìº¡ì²˜ + ğŸ“· ìŠ¤í¬ë¦°ìƒ· ì €ì¥ ê¸°ëŠ¥<br>
                    - ğŸ¨ UI ì „ë©´ ê°œí¸: ì‹ ê²½ì„¸í¬ ì‹œë®¬ë ˆì´í„°ì™€ ë””ìì¸ í†µì¼<br>
                    - ğŸ“± ë°˜ì‘í˜• ë””ìì¸ + ì ‘ê·¼ì„± ê°œì„ <br>
                </div>
                <div class="help-section">
                    <div class="log-date">2025. 11. (v1.1)</div>
                    <strong>v1.1 íŒ¨ì¹˜</strong><br>
                    - ê¸°ì¤€ê°’ ì„¤ì •, Mì„  ë™ì  ìœ„ì¹˜ ì¡°ì •, ê¸¸ì´ ê³„ì‚°ê¸° ì¶”ê°€<br>
                </div>
                <div class="help-section">
                    <div class="log-date">2025. 10. (v1.0)</div>
                    <strong>v1.0 ì¶œì‹œ</strong><br>
                    ê·¼ìœ¡ ìˆ˜ì¶• ìŠ¬ë¼ì´ë”© í•„ë¼ë©˜íŠ¸ ì‹œë®¬ë ˆì´í„° ìµœì´ˆ ê³µê°œ.
                </div>
            </div>
        </div>
    </div>

    <script>
    const A_BAND = 1.6;
    const ACTIN = 1.0;
    const BASELINE = 2.4;
    const FACTOR = 700 / 3.6;
    const CENTER_X = 400;
    const SPEED_MAP = { slow: 0.3, normal: 1, fast: 2.5 };

    const sarcomereLengthTable = Array.from({ length: 17 }, (_, i) => +(2.0 + i * 0.1).toFixed(1));

    const lengthOptions = ["AëŒ€ ê¸¸ì´", "ë§ˆì´ì˜¤ì‹ ", "ì•¡í‹´", "HëŒ€ ê¸¸ì´", "IëŒ€ ê¸¸ì´", "ê²¹ì¹˜ëŠ” êµ¬ê°„", "Â½ IëŒ€ ê¸¸ì´", "Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„"];

    const referenceValues = {
        "AëŒ€ ê¸¸ì´": A_BAND,
        "ë§ˆì´ì˜¤ì‹ ": A_BAND,
        "ì•¡í‹´": ACTIN,
        "HëŒ€ ê¸¸ì´": +(BASELINE - 2 * ACTIN).toFixed(2),
        "IëŒ€ ê¸¸ì´": +(BASELINE - A_BAND).toFixed(2),
        "Â½ IëŒ€ ê¸¸ì´": +((BASELINE - A_BAND) / 2).toFixed(2),
        "ê²¹ì¹˜ëŠ” êµ¬ê°„": +(2 * Math.max(0, ACTIN - (BASELINE - A_BAND) / 2)).toFixed(2),
        "Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„": +(Math.max(0, ACTIN - (BASELINE - A_BAND) / 2)).toFixed(2)
    };

    let calculatorRows = [
        ["HëŒ€ ê¸¸ì´", "+", "ê²¹ì¹˜ëŠ” êµ¬ê°„"],
        ["Â½ IëŒ€ ê¸¸ì´", "+", "Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„"],
        ["AëŒ€ ê¸¸ì´", "+", "IëŒ€ ê¸¸ì´"],
        ["", "+", ""],
        ["", "+", ""],
        ["", "+", ""]
    ];

    let snapshots = [];
    let forceChart = null;
    let anim = { playing: false, direction: 1, speed: 1, rafId: null, lastTime: 0 };

    function getForcePercent(s) {
        if (s >= 3.6) return 0;
        if (s >= 2.2) return ((3.6 - s) / (3.6 - 2.2)) * 100;
        if (s >= 2.0) return 100;
        if (s <= 1.6) return 50;
        return 100 - ((2.0 - s) / (2.0 - 1.6)) * 50;
    }

    function calculateLengths(sarcomereUm) {
        const hBand = Math.max(0, sarcomereUm - 2 * ACTIN);
        const iBand = Math.max(0, sarcomereUm - A_BAND);
        const overlapPerSide = Math.max(0, ACTIN - iBand / 2);
        const totalOverlap = 2 * overlapPerSide;
        return {
            "AëŒ€ ê¸¸ì´": A_BAND, "ë§ˆì´ì˜¤ì‹ ": A_BAND, "ì•¡í‹´": ACTIN,
            "HëŒ€ ê¸¸ì´": hBand, "IëŒ€ ê¸¸ì´": iBand,
            "ê²¹ì¹˜ëŠ” êµ¬ê°„": totalOverlap, "Â½ IëŒ€ ê¸¸ì´": iBand / 2,
            "Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„": overlapPerSide
        };
    }

    function drawMuscle(sarcomereUm) {
        const svg = document.getElementById('muscleSvg');
        sarcomereUm = Math.max(sarcomereUm, 2.0);
        const sarPx = sarcomereUm * FACTOR;
        const actinPx = ACTIN * FACTOR;
        const myosinPx = A_BAND * FACTOR;
        const leftZ = CENTER_X - sarPx / 2;
        const rightZ = CENTER_X + sarPx / 2;
        const myosinStart = CENTER_X - myosinPx / 2;
        const myosinEnd = CENTER_X + myosinPx / 2;
        const leftActinEnd = leftZ + actinPx;
        const rightActinStart = rightZ - actinPx;

        const leftOvS = Math.max(myosinStart, leftZ);
        const leftOvE = Math.min(myosinEnd, leftActinEnd);
        const rightOvS = Math.max(myosinStart, rightActinStart);
        const rightOvE = Math.min(myosinEnd, rightZ);
        const hStart = Math.max(leftActinEnd, myosinStart);
        const hEnd = Math.min(rightActinStart, myosinEnd);
        const halfIL = myosinStart - leftZ;
        const halfIR = rightZ - myosinEnd;

        let s = '';
        const fTop = 100, fBot = 220;
        const actY = [108, 138, 168, 198];
        const myoY = [120, 153, 186];
        const myoH = 10, actH = 4;

        if (leftOvE > leftOvS) s += `<rect x="${leftOvS}" y="${fTop-5}" width="${leftOvE-leftOvS}" height="${fBot-fTop+10}" fill="#8B45A6" opacity="0.12" rx="2"/>`;
        if (rightOvE > rightOvS) s += `<rect x="${rightOvS}" y="${fTop-5}" width="${rightOvE-rightOvS}" height="${fBot-fTop+10}" fill="#8B45A6" opacity="0.12" rx="2"/>`;

        actY.forEach(y => {
            s += `<rect x="${leftZ}" y="${y-actH/2}" width="${actinPx}" height="${actH}" fill="#4169E1" rx="2"/>`;
            s += `<rect x="${rightZ-actinPx}" y="${y-actH/2}" width="${actinPx}" height="${actH}" fill="#4169E1" rx="2"/>`;
        });

        myoY.forEach(y => {
            s += `<rect x="${myosinStart}" y="${y-myoH/2}" width="${myosinPx}" height="${myoH}" fill="#DC143C" rx="3"/>`;
            const sp = myosinPx / 8;
            for (let i = 1; i <= 3; i++) {
                const xL = myosinStart + sp * i, xR = myosinEnd - sp * i;
                const above = actY.filter(a => a < y);
                const below = actY.filter(a => a > y);
                const na = above.length > 0 ? above[above.length-1] : null;
                const nb = below.length > 0 ? below[0] : null;
                if (na !== null) {
                    s += `<line x1="${xL}" y1="${y-myoH/2}" x2="${xL-4}" y2="${na+actH/2+1}" stroke="#DC143C" stroke-width="1.5" opacity="0.7"/>`;
                    s += `<line x1="${xR}" y1="${y-myoH/2}" x2="${xR+4}" y2="${na+actH/2+1}" stroke="#DC143C" stroke-width="1.5" opacity="0.7"/>`;
                }
                if (nb !== null) {
                    s += `<line x1="${xL}" y1="${y+myoH/2}" x2="${xL-4}" y2="${nb-actH/2-1}" stroke="#DC143C" stroke-width="1.5" opacity="0.7"/>`;
                    s += `<line x1="${xR}" y1="${y+myoH/2}" x2="${xR+4}" y2="${nb-actH/2-1}" stroke="#DC143C" stroke-width="1.5" opacity="0.7"/>`;
                }
            }
        });

        s += `<line x1="${leftZ}" y1="${fTop-15}" x2="${leftZ}" y2="${fBot+15}" stroke="#1a5276" stroke-width="5"/>`;
        s += `<line x1="${rightZ}" y1="${fTop-15}" x2="${rightZ}" y2="${fBot+15}" stroke="#1a5276" stroke-width="5"/>`;
        s += `<text x="${leftZ}" y="${fTop-22}" font-size="13" text-anchor="middle" fill="#1a5276" font-weight="bold">Z</text>`;
        s += `<text x="${rightZ}" y="${fTop-22}" font-size="13" text-anchor="middle" fill="#1a5276" font-weight="bold">Z</text>`;
        s += `<line x1="${CENTER_X}" y1="${fTop-10}" x2="${CENTER_X}" y2="${fBot+10}" stroke="#FFA500" stroke-width="2.5" stroke-dasharray="6 4"/>`;
        s += `<text x="${CENTER_X}" y="${fTop-22}" font-size="13" text-anchor="middle" fill="#FFA500" font-weight="bold">M</text>`;

        const bY = fBot + 30, aH = 8;
        s += `<line x1="${myosinStart}" y1="${bY}" x2="${myosinEnd}" y2="${bY}" stroke="#DC143C" stroke-width="2"/>`;
        s += `<line x1="${myosinStart}" y1="${bY-aH}" x2="${myosinStart}" y2="${bY+aH}" stroke="#DC143C" stroke-width="1.5"/>`;
        s += `<line x1="${myosinEnd}" y1="${bY-aH}" x2="${myosinEnd}" y2="${bY+aH}" stroke="#DC143C" stroke-width="1.5"/>`;
        s += `<text x="${CENTER_X}" y="${bY-10}" font-size="12" text-anchor="middle" fill="#DC143C" font-weight="bold">AëŒ€ (${A_BAND}Î¼m)</text>`;

        if (hEnd > hStart + 2) {
            const hY = bY + 25;
            s += `<line x1="${hStart}" y1="${hY}" x2="${hEnd}" y2="${hY}" stroke="#4169E1" stroke-width="2"/>`;
            s += `<line x1="${hStart}" y1="${hY-aH}" x2="${hStart}" y2="${hY+aH}" stroke="#4169E1" stroke-width="1.5"/>`;
            s += `<line x1="${hEnd}" y1="${hY-aH}" x2="${hEnd}" y2="${hY+aH}" stroke="#4169E1" stroke-width="1.5"/>`;
            s += `<text x="${(hStart+hEnd)/2}" y="${hY-10}" font-size="11" text-anchor="middle" fill="#4169E1" font-weight="bold">HëŒ€ (${Math.max(0,sarcomereUm-2*ACTIN).toFixed(2)}Î¼m)</text>`;
        }

        if (halfIL > 2) {
            const iY = bY + 50;
            s += `<line x1="${leftZ}" y1="${iY}" x2="${myosinStart}" y2="${iY}" stroke="#228B22" stroke-width="2"/>`;
            s += `<line x1="${leftZ}" y1="${iY-aH}" x2="${leftZ}" y2="${iY+aH}" stroke="#228B22" stroke-width="1.5"/>`;
            s += `<line x1="${myosinStart}" y1="${iY-aH}" x2="${myosinStart}" y2="${iY+aH}" stroke="#228B22" stroke-width="1.5"/>`;
            s += `<text x="${(leftZ+myosinStart)/2}" y="${iY-10}" font-size="11" text-anchor="middle" fill="#228B22" font-weight="bold">Â½IëŒ€ (${(halfIL/FACTOR).toFixed(2)}Î¼m)</text>`;
        }
        if (halfIR > 2) {
            const iY = bY + 50;
            s += `<line x1="${myosinEnd}" y1="${iY}" x2="${rightZ}" y2="${iY}" stroke="#228B22" stroke-width="2"/>`;
            s += `<line x1="${myosinEnd}" y1="${iY-aH}" x2="${myosinEnd}" y2="${iY+aH}" stroke="#228B22" stroke-width="1.5"/>`;
            s += `<line x1="${rightZ}" y1="${iY-aH}" x2="${rightZ}" y2="${iY+aH}" stroke="#228B22" stroke-width="1.5"/>`;
            s += `<text x="${(myosinEnd+rightZ)/2}" y="${iY-10}" font-size="11" text-anchor="middle" fill="#228B22" font-weight="bold">Â½IëŒ€ (${(halfIR/FACTOR).toFixed(2)}Î¼m)</text>`;
        }

        const scPx = 1.0 * FACTOR;
        s += `<line x1="20" y1="55" x2="${20+scPx}" y2="55" stroke="#333" stroke-width="2"/>`;
        s += `<line x1="20" y1="50" x2="20" y2="60" stroke="#333" stroke-width="2"/>`;
        s += `<line x1="${20+scPx}" y1="50" x2="${20+scPx}" y2="60" stroke="#333" stroke-width="2"/>`;
        s += `<text x="${20+scPx/2}" y="47" font-size="11" text-anchor="middle" fill="#333" font-weight="bold">1.0 Î¼m</text>`;

        s += `<rect x="20" y="15" width="12" height="8" fill="#4169E1" rx="2"/>`;
        s += `<text x="36" y="23" font-size="10" fill="#333">Actin</text>`;
        s += `<rect x="85" y="15" width="12" height="8" fill="#DC143C" rx="2"/>`;
        s += `<text x="101" y="23" font-size="10" fill="#333">Myosin</text>`;
        s += `<rect x="160" y="15" width="12" height="8" fill="#8B45A6" opacity="0.4" rx="2"/>`;
        s += `<text x="176" y="23" font-size="10" fill="#333">Overlap</text>`;

        const fp = getForcePercent(sarcomereUm);
        s += `<text x="780" y="55" font-size="12" text-anchor="end" fill="#333" font-weight="bold">ì¥ë ¥: ${fp.toFixed(0)}%</text>`;

        const viewH = Math.max(300, bY + 70);
        svg.setAttribute('viewBox', `0 0 800 ${viewH}`);
        svg.innerHTML = s;
    }

    function updateLengthInfo(lengths, sarcomereUm) {
        const items = [
            { name: "ê·¼ì ˆ ê¸¸ì´", value: sarcomereUm },
            { name: "AëŒ€ ê¸¸ì´", value: lengths["AëŒ€ ê¸¸ì´"] },
            { name: "ì•¡í‹´ ê¸¸ì´", value: lengths["ì•¡í‹´"] },
            { name: "HëŒ€ ê¸¸ì´", value: lengths["HëŒ€ ê¸¸ì´"] },
            { name: "IëŒ€ ê¸¸ì´", value: lengths["IëŒ€ ê¸¸ì´"] },
            { name: "ê²¹ì¹˜ëŠ” êµ¬ê°„", value: lengths["ê²¹ì¹˜ëŠ” êµ¬ê°„"] }
        ];
        document.getElementById('lengthList').innerHTML = items.map(i =>
            `<li>${i.name}: <strong>${i.value.toFixed(2)} Î¼m</strong></li>`
        ).join('');
    }

    function updateChanges(lengths) {
        const items = [
            { name: "HëŒ€ ê¸¸ì´", value: lengths["HëŒ€ ê¸¸ì´"], ref: referenceValues["HëŒ€ ê¸¸ì´"] },
            { name: "IëŒ€ ê¸¸ì´", value: lengths["IëŒ€ ê¸¸ì´"], ref: referenceValues["IëŒ€ ê¸¸ì´"] },
            { name: "ê²¹ì¹˜ëŠ” êµ¬ê°„", value: lengths["ê²¹ì¹˜ëŠ” êµ¬ê°„"], ref: referenceValues["ê²¹ì¹˜ëŠ” êµ¬ê°„"] },
            { name: "Â½ IëŒ€ ê¸¸ì´", value: lengths["Â½ IëŒ€ ê¸¸ì´"], ref: referenceValues["Â½ IëŒ€ ê¸¸ì´"] },
            { name: "Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„", value: lengths["Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„"], ref: referenceValues["Â½ ê²¹ì¹˜ëŠ” êµ¬ê°„"] }
        ];
        document.getElementById('changesList').innerHTML = items.map(i => {
            const d = i.value - i.ref;
            const cls = d < -0.001 ? 'delta-negative' : d > 0.001 ? 'delta-positive' : 'delta-info';
            return `<li>${i.name}: <strong>${i.value.toFixed(2)} Î¼m</strong> <span class="${cls}">(Î” ${d >= 0 ? '+' : ''}${d.toFixed(2)})</span></li>`;
        }).join('');
    }

    function updateLiveRow(sarcomereUm, lengths) {
        const force = getForcePercent(sarcomereUm);
        const tbody = document.getElementById('dataTableBody');
        let live = tbody.querySelector('.live-row');
        if (!live) {
            live = document.createElement('tr');
            live.className = 'live-row';
            live.innerHTML = `<td class="label-cell"></td><td class="value-cell"></td><td class="value-cell"></td><td class="value-cell"></td><td class="value-cell"></td><td class="value-cell"></td><td>-</td>`;
            tbody.insertBefore(live, tbody.firstChild);
        }
        const cells = live.querySelectorAll('td');
        cells[0].textContent = sarcomereUm.toFixed(2);
        cells[1].textContent = lengths["AëŒ€ ê¸¸ì´"].toFixed(2);
        cells[2].textContent = lengths["IëŒ€ ê¸¸ì´"].toFixed(2);
        cells[3].textContent = lengths["HëŒ€ ê¸¸ì´"].toFixed(2);
        cells[4].textContent = lengths["ê²¹ì¹˜ëŠ” êµ¬ê°„"].toFixed(2);
        cells[5].textContent = force.toFixed(0);
    }

    function createCalculatorTable() {
        const table = document.getElementById('calculatorTable');
        table.innerHTML = '';
        for (let i = 0; i < 6; i++) {
            const row = document.createElement('tr');
            const s1 = document.createElement('select');
            s1.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>' + lengthOptions.map(o => `<option value="${o}">${o}</option>`).join('');
            s1.value = calculatorRows[i][0];
            s1.onchange = () => { calculatorRows[i][0] = s1.value; updateCalculator(); };

            const sOp = document.createElement('select');
            sOp.className = 'operator-select';
            sOp.innerHTML = '<option value="+">+</option><option value="-">âˆ’</option><option value="*">Ã—</option><option value="/">Ã·</option>';
            sOp.value = calculatorRows[i][1];
            sOp.onchange = () => { calculatorRows[i][1] = sOp.value; updateCalculator(); };

            const s2 = document.createElement('select');
            s2.innerHTML = '<option value="">ì„ íƒ ì•ˆ í•¨</option>' + lengthOptions.map(o => `<option value="${o}">${o}</option>`).join('');
            s2.value = calculatorRows[i][2];
            s2.onchange = () => { calculatorRows[i][2] = s2.value; updateCalculator(); };

            const td1 = document.createElement('td'); td1.appendChild(s1);
            const td2 = document.createElement('td'); td2.appendChild(sOp);
            const td3 = document.createElement('td'); td3.appendChild(s2);
            const td4 = document.createElement('td'); td4.id = `calc-result-${i}`;
            row.append(td1, td2, td3, td4);
            table.appendChild(row);
        }
    }

    function updateCalculator() {
        const slider = document.getElementById('sarcomereSlider');
        const sarcomereUm = sarcomereLengthTable[slider.value];
        const lengths = calculateLengths(sarcomereUm);
        calculatorRows.forEach((r, idx) => {
            const cell = document.getElementById(`calc-result-${idx}`);
            const [k1, op, k2] = r;
            if (!k1 && !k2) { cell.textContent = '-'; return; }
            if (!k1 || !k2) { cell.textContent = 'ê°’ì„ ì„ íƒí•˜ì„¸ìš”'; cell.style.color = '#999'; return; }
            const v1 = lengths.hasOwnProperty(k1) ? lengths[k1] : 0;
            const v2 = lengths.hasOwnProperty(k2) ? lengths[k2] : 0;
            let result;
            switch (op) {
                case '+': result = v1 + v2; break;
                case '-': result = v1 - v2; break;
                case '*': result = v1 * v2; break;
                case '/':
                    if (v2 === 0) { cell.textContent = '0ìœ¼ë¡œ ë‚˜ëˆŒ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'; cell.style.color = '#dc3545'; return; }
                    result = v1 / v2; break;
                default: result = v1 + v2;
            }
            if (op === '+') {
                const r1 = referenceValues[k1] || 0;
                const r2 = referenceValues[k2] || 0;
                const d = result - (r1 + r2);
                const cls = d < -0.001 ? 'delta-negative' : d > 0.001 ? 'delta-positive' : '';
                cell.innerHTML = `${result.toFixed(2)} Î¼m <span class="${cls}">(Î” ${d >= 0 ? '+' : ''}${d.toFixed(2)})</span>`;
            } else {
                cell.innerHTML = `<strong>${result.toFixed(2)}</strong> ${op === '/' ? '' : 'Î¼m'}`;
            }
            cell.style.color = '#333';
        });
    }

    function initForceChart() {
        const ctx = document.getElementById('forceChart').getContext('2d');
        const curveData = [];
        for (let s = 1.4; s <= 4.0; s += 0.02) curveData.push({ x: +s.toFixed(2), y: +getForcePercent(s).toFixed(1) });

        const greenZone = {
            id: 'greenZone',
            beforeDraw(chart) {
                const { ctx: c, chartArea, scales } = chart;
                if (!chartArea) return;
                const x = scales.x;
                const zones = [
                    { x1: 1.4, x2: 1.67, color: 'rgba(220,53,69,0.08)' },
                    { x1: 1.67, x2: 2.0, color: 'rgba(255,193,7,0.08)' },
                    { x1: 2.0, x2: 2.2, color: 'rgba(40,167,69,0.12)' },
                    { x1: 2.2, x2: 3.0, color: 'rgba(255,193,7,0.08)' },
                    { x1: 3.0, x2: 4.0, color: 'rgba(220,53,69,0.08)' }
                ];
                c.save();
                zones.forEach(z => {
                    const l = Math.max(x.getPixelForValue(z.x1), chartArea.left);
                    const r = Math.min(x.getPixelForValue(z.x2), chartArea.right);
                    if (r > l) { c.fillStyle = z.color; c.fillRect(l, chartArea.top, r - l, chartArea.bottom - chartArea.top); }
                });
                c.restore();
            }
        };
        const markerLine = {
            id: 'markerLine',
            afterDraw(chart) {
                const { ctx: c, chartArea, scales } = chart;
                if (!chartArea || chart._currentS === undefined) return;
                const px = scales.x.getPixelForValue(chart._currentS);
                if (px < chartArea.left || px > chartArea.right) return;
                c.save(); c.beginPath(); c.setLineDash([6, 4]);
                c.strokeStyle = '#3d4e9f'; c.lineWidth = 2;
                c.moveTo(px, chartArea.top); c.lineTo(px, chartArea.bottom);
                c.stroke(); c.restore();
            }
        };
        forceChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [
                    { label: 'ì¥ë ¥ ê³¡ì„ ', data: curveData, borderColor: '#3d4e9f', backgroundColor: 'rgba(61,78,159,0.05)', borderWidth: 3, pointRadius: 0, showLine: true, tension: 0.1, fill: true },
                    { label: 'í˜„ì¬', data: [{ x: BASELINE, y: getForcePercent(BASELINE) }], borderColor: '#DC143C', backgroundColor: '#DC143C', pointRadius: 8, pointHoverRadius: 10, showLine: false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: true, aspectRatio: 2.5,
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.parsed.x.toFixed(1)} Î¼m, ${c.parsed.y.toFixed(0)}%` } } },
                scales: {
                    x: { type: 'linear', min: 1.4, max: 4.0, title: { display: true, text: 'ê·¼ì ˆ ê¸¸ì´ (Î¼m)', font: { size: 13, weight: 'bold' } }, ticks: { stepSize: 0.2, font: { size: 10 } }, grid: { color: 'rgba(0,0,0,0.06)' } },
                    y: { min: 0, max: 100, title: { display: true, text: 'ìƒëŒ€ì  ì¥ë ¥ (%)', font: { size: 13, weight: 'bold' } }, ticks: { stepSize: 20, font: { size: 10 } }, grid: { color: 'rgba(0,0,0,0.06)' } }
                }
            },
            plugins: [greenZone, markerLine]
        });
        forceChart._currentS = BASELINE;
    }

    function updateForceChart(sarcomereUm) {
        if (!forceChart) return;
        forceChart.data.datasets[1].data = [{ x: sarcomereUm, y: getForcePercent(sarcomereUm) }];
        forceChart._currentS = sarcomereUm;
        forceChart.update('none');
    }

    function toggleAnimation() {
        if (anim.playing) {
            anim.playing = false;
            if (anim.rafId) cancelAnimationFrame(anim.rafId);
            anim.rafId = null;
            document.getElementById('playBtn').textContent = 'â–¶ ì¬ìƒ';
            document.getElementById('playBtn').classList.remove('playing');
        } else {
            anim.playing = true;
            anim.lastTime = performance.now();
            document.getElementById('playBtn').textContent = 'â¸ ì¼ì‹œì •ì§€';
            document.getElementById('playBtn').classList.add('playing');
            anim.rafId = requestAnimationFrame(animateStep);
        }
    }

    function animateStep(ts) {
        if (!anim.playing) return;
        const elapsed = ts - anim.lastTime;
        const interval = 400 / anim.speed;
        if (elapsed >= interval) {
            anim.lastTime = ts;
            const slider = document.getElementById('sarcomereSlider');
            let val = parseInt(slider.value) + anim.direction;
            if (val >= 16) { val = 16; anim.direction = -1; }
            else if (val <= 0) { val = 0; anim.direction = 1; }
            slider.value = val;
            update();
        }
        anim.rafId = requestAnimationFrame(animateStep);
    }

    function captureSnapshot() {
        const slider = document.getElementById('sarcomereSlider');
        const s = sarcomereLengthTable[slider.value];
        const l = calculateLengths(s);
        snapshots.push({ id: Date.now(), s, a: l["AëŒ€ ê¸¸ì´"], i: l["IëŒ€ ê¸¸ì´"], h: l["HëŒ€ ê¸¸ì´"], o: l["ê²¹ì¹˜ëŠ” êµ¬ê°„"], f: getForcePercent(s) });
        renderSnapshots();
    }

    function deleteSnapshot(id) {
        snapshots = snapshots.filter(x => x.id !== id);
        renderSnapshots();
    }

    function renderSnapshots() {
        const tbody = document.getElementById('dataTableBody');
        const live = tbody.querySelector('.live-row');
        tbody.innerHTML = '';
        if (live) tbody.appendChild(live);
        snapshots.forEach(snap => {
            const tr = document.createElement('tr');
            tr.style.backgroundColor = 'var(--bg-light)';
            tr.innerHTML = `<td>${snap.s.toFixed(2)}</td><td>${snap.a.toFixed(2)}</td><td>${snap.i.toFixed(2)}</td><td>${snap.h.toFixed(2)}</td><td>${snap.o.toFixed(2)}</td><td>${snap.f.toFixed(0)}</td><td><button class="delete-btn" onclick="deleteSnapshot(${snap.id})">ì‚­ì œ</button></td>`;
            tbody.appendChild(tr);
        });
    }

    async function captureScreenshot() {
        const btn = document.getElementById('screenshotBtn');
        btn.disabled = true; btn.textContent = 'ìº¡ì²˜ ì¤‘...';
        try {
            const canvas = await html2canvas(document.querySelector('.container'), { backgroundColor: '#ffffff', scale: 2, useCORS: true, logging: false });
            const link = document.createElement('a');
            link.download = `ê·¼ìˆ˜ì¶•_${sarcomereLengthTable[document.getElementById('sarcomereSlider').value].toFixed(1)}um.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        } catch (e) { alert('ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
        finally { btn.disabled = false; btn.textContent = 'ğŸ“· ìŠ¤í¬ë¦°ìƒ·'; }
    }

    function resetAll() {
        if (anim.playing) toggleAnimation();
        anim.direction = 1;
        document.getElementById('sarcomereSlider').value = 4;
        snapshots = [];
        renderSnapshots();
        update();
    }

    function openModal(id) { document.getElementById(id).style.display = 'block'; }
    function closeModalEl(id) { document.getElementById(id).style.display = 'none'; }

    function update() {
        const slider = document.getElementById('sarcomereSlider');
        const sarcomereUm = sarcomereLengthTable[slider.value];
        const delta = sarcomereUm - BASELINE;

        document.getElementById('lengthDisplay').textContent = `${sarcomereUm.toFixed(2)} Î¼m`;
        document.getElementById('sliderValue').textContent = `${sarcomereUm.toFixed(2)} Î¼m`;

        const dd = document.getElementById('deltaDisplay');
        if (Math.abs(delta) < 0.01) { dd.textContent = '(ê¸°ì¤€ê°’)'; dd.style.color = 'var(--text-secondary)'; }
        else { dd.textContent = `(${delta > 0 ? '+' : ''}${delta.toFixed(2)} Î¼m)`; dd.style.color = delta > 0 ? 'var(--accent-green)' : 'var(--accent-red)'; }

        drawMuscle(sarcomereUm);
        updateForceChart(sarcomereUm);
        const lengths = calculateLengths(sarcomereUm);
        updateLengthInfo(lengths, sarcomereUm);
        updateChanges(lengths);
        updateLiveRow(sarcomereUm, lengths);
        updateCalculator();
    }

    document.getElementById('sarcomereSlider').addEventListener('input', update);
    document.getElementById('playBtn').addEventListener('click', toggleAnimation);
    document.getElementById('resetBtn').addEventListener('click', resetAll);
    document.getElementById('captureBtn').addEventListener('click', captureSnapshot);
    document.getElementById('screenshotBtn').addEventListener('click', captureScreenshot);
    document.getElementById('theoryBtn').addEventListener('click', () => openModal('theoryModal'));
    document.getElementById('devLogBtn').addEventListener('click', () => openModal('devLogModal'));
    document.getElementById('helpBtn').addEventListener('click', () => openModal('helpModal'));
    document.getElementById('theoryClose').addEventListener('click', () => closeModalEl('theoryModal'));
    document.getElementById('helpClose').addEventListener('click', () => closeModalEl('helpModal'));
    document.getElementById('devLogClose').addEventListener('click', () => closeModalEl('devLogModal'));
    document.getElementById('speedSelect').addEventListener('change', e => { anim.speed = SPEED_MAP[e.target.value] || 1; });
    document.getElementById('graphToggle').addEventListener('change', e => {
        document.getElementById('forceGraph').classList.toggle('graph-hidden', !e.target.checked);
    });
    window.addEventListener('click', e => { if (e.target.classList.contains('modal')) e.target.style.display = 'none'; });

    createCalculatorTable();
    initForceChart();
    update();
    </script>
</body>
</html>
