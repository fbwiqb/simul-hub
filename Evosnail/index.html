<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¬íŒ½ì´ ì§„í™” ì‹œë®¬ë ˆì´ì…˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
       body {
    font-family: 'Malgun Gothic', sans-serif;
    background: linear-gradient(135deg, #f8f9ff 0%, #eef0f8 100%);
    min-height: 100vh;
    padding: 10px;
    margin: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
        
        /* ì´ˆê¸° ì„ íƒ í™”ë©´ */
        .selection-screen {
            max-width: 1200px;
            margin: 50px auto;
            text-align: center;
        }
        
        .selection-screen h1 {
            color: #3d4e9f;
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: none;
        }
        
        .selection-screen p {
            color: #333;
            font-size: 1.3em;
            margin-bottom: 50px;
        }
        
        /* í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        .home-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 40px;
        }
        
        .home-btn {
            background: linear-gradient(135deg, #3d4e9f 0%, #5865b5 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(61, 78, 159, 0.25);
        }

        .home-btn:hover {
            background: linear-gradient(135deg, #2d3e8f 0%, #4855a5 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(61, 78, 159, 0.5);
        }

        .home-btn:active {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(61, 78, 159, 0.4);
        }
        
        .scenario-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin: 0 auto;
            max-width: 1000px;
        }
        
        .scenario-card {
            background: white;
            border: 3px solid #3d4e9f;
            border-radius: 20px;
            padding: 40px 30px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(61, 78, 159, 0.15);
        }

        .scenario-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 0 20px 40px rgba(61, 78, 159, 0.35);
            background: linear-gradient(to bottom, #ffffff 0%, #f8f9ff 100%);
            border-color: #5865b5;
        }
        
        .scenario-card .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .scenario-card h2 {
            color: #3d4e9f;
            margin-bottom: 15px;
            font-size: 1.8em;
        }
        
        .scenario-card p {
            color: #666;
            font-size: 1em;
            line-height: 1.6;
        }
        
        .speed-card { background: white; border-color: #3d4e9f; }
        .color-card { background: white; border-color: #3d4e9f; }
        .size-card { background: white; border-color: #3d4e9f; }
        
        /* íŒì—… ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 70px rgba(0,0,0,0.35);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #3d4e9f;
            color: white;
            padding: 20px;
            margin: -30px -30px 20px -30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            color: white;
            margin: 0;
            font-size: 1.8em;
        }
        
        .modal-close {
            background: none;
            color: white;
            border: none;
            font-size: 30px;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: none;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }
        
        .log-entry {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
            border-left: 4px solid #3d4e9f;
        }
        
        .log-date {
            color: #3d4e9f;
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .log-text {
            color: #333;
            line-height: 1.8;
        }
        
        .log-text strong {
            color: #3d4e9f;
        }
        
        .log-text a {
            color: #3d4e9f;
            text-decoration: none;
        }
        
        .log-text a:hover {
            text-decoration: underline;
        }
        
        .distribution-setup {
            margin: 20px 0;
        }
        
        .trait-level {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .trait-level label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #495057;
            font-weight: bold;
        }
        
        .trait-level input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            font-size: 1em;
            text-align: center;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .modal-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-start {
            background: #3d4e9f;
            color: white;
        }
        
        .btn-cancel {
            background: #e9ecef;
            color: #495057;
        }
        
        .btn-start:hover {
            background: #2d3e8f;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(61, 78, 159, 0.3);
        }
        
        /* ì‹œë®¬ë ˆì´ì…˜ í™”ë©´ - ìˆ˜ì§ ë ˆì´ì•„ì›ƒ */
        .simulation-screen {
            display: none;
            max-width: 1000px;
            width: 90%;
            height: auto;
            max-height: 95vh;
            margin: auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 25px 70px rgba(0,0,0,0.35);
            overflow-y: auto;
        }
        
        .simulation-screen.active {
            display: block;
        }
        
        .sim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .sim-title-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .sim-title {
            font-size: 1.8em;
            color: #3d4e9f;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        .header-controls button {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-back {
            padding: 10px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #495057;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            background: #dee2e6;
        }
        
        .main-area {
            display: grid;
            grid-template-columns: 3fr 1.5fr;
            gap: 15px;
            margin-bottom: 15px;
            min-height: 300px;
            max-height: 600px;
        }
        
        #gameCanvas {
            border: 3px solid #3d4e9f;
            border-radius: 10px;
            cursor: crosshair;
            box-shadow: 0 8px 24px rgba(61, 78, 159, 0.25);
            width: 100%;
            height: 100%;
            transition: box-shadow 0.3s ease;
        }

        #gameCanvas:hover {
            box-shadow: 0 12px 32px rgba(61, 78, 159, 0.3);
        }
        
        .stats-panel, .graph-panel {
            height: 100%;
        }
        
        .stats-panel {
            background: linear-gradient(to bottom, #f8f9ff 0%, #ffffff 100%);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(61, 78, 159, 0.15);
            font-size: 0.9em;
            overflow-y: auto;
            border: 2px solid #3d4e9f;
        }
        
        .graph-panel {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(61, 78, 159, 0.1);
            border: 2px solid #3d4e9f;
            display: none;
        }
        
        .graph-panel h3 {
            color: #3d4e9f;
            margin-bottom: 15px;
            border-bottom: 2px solid #3d4e9f;
            padding-bottom: 10px;
        }
        
        #sideChart {
            max-height: 250px;
        }
        
        .stats-panel h3 {
            color: #3d4e9f;
            margin-bottom: 15px;
            border-bottom: 2px solid #3d4e9f;
            padding-bottom: 10px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            background: #f8f9ff;
            transform: translateX(2px);
        }
        
        .stat-label {
            font-weight: bold;
            color: #6c757d;
        }
        
        .stat-value {
            color: #3d4e9f;
            font-weight: bold;
        }
        
        .controls {
            background: #f8f9ff;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(61, 78, 159, 0.1);
            border: 2px solid #3d4e9f;
            flex-shrink: 0;
            display: flex;
            gap: 15px;
        }
        
        .control-section {
            flex: 1;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .control-section h3 {
            color: #3d4e9f;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .mode-button {
            padding: 15px;
            border: 2px solid #3d4e9f;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-align: center;
            color: #3d4e9f;
        }
        
        .mode-button.active {
            background: #3d4e9f;
            color: white;
            border-color: #3d4e9f;
        }
        
        .bg-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .bg-button {
            padding: 12px;
            border: 2px solid #3d4e9f;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            text-align: center;
            color: #3d4e9f;
        }
        
        .bg-button.active {
            color: white;
            border-color: #3d4e9f;
        }
        
        .bg-button.active.grassland {
            background: #4CAF50;
        }
        
        .bg-button.active.openfield {
            background: #8B4513;
        }
        
        .control-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        button {
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 8px rgba(61, 78, 159, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #3d4e9f 0%, #5865b5 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #3d4e9f 0%, #5865b5 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #e85563 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #ffd04a 100%);
            color: #333;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(61, 78, 159, 0.35);
        }

        button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(61, 78, 159, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2d3e8f 0%, #4855a5 100%);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #d84453 100%);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e0a800 0%, #f0c040 100%);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .checkbox-group label {
            cursor: pointer;
            color: #495057;
            font-weight: 500;
        }
        
        .slider-group {
            margin: 15px 0;
        }
        
        .slider-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #dee2e6;
            border-radius: 3px;
            outline: none;
        }
        
        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3d4e9f;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3d4e9f;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #3d4e9f;
        }   
        .keyboard-hints {
            text-align: center;
            padding: 6px 12px;
            margin-top: 10px;
            color: #8a8faa;
            font-size: 12px;
            background: rgba(61, 78, 159, 0.04);
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .controls {
                display: block;
            }

            .control-section {
                margin-bottom: 10px;
            }

            .main-area {
                grid-template-columns: 1fr;
                max-height: none;
            }

            .sim-header {
                flex-direction: column;
                gap: 10px;
            }

            .scenario-cards {
                grid-template-columns: 1fr;
            }

            .genetics-cards {
                grid-template-columns: 1fr;
            }

            .sim-title {
                font-size: 1.4em;
            }

            .keyboard-hints {
                display: none;
            }
        }

        .genetics-section {
            max-width: 1000px;
            margin: 50px auto 0;
            text-align: left;
        }

        .genetics-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            padding: 16px 24px;
            background: linear-gradient(135deg, rgba(61, 78, 159, 0.06) 0%, rgba(88, 101, 181, 0.1) 100%);
            border: 2px solid rgba(61, 78, 159, 0.15);
            border-radius: 14px;
            transition: all 0.3s ease;
            user-select: none;
        }

        .genetics-toggle:hover {
            background: linear-gradient(135deg, rgba(61, 78, 159, 0.1) 0%, rgba(88, 101, 181, 0.15) 100%);
            border-color: rgba(61, 78, 159, 0.3);
        }

        .genetics-toggle h2 {
            color: #3d4e9f;
            font-size: 1.4em;
            margin: 0;
        }

        .genetics-toggle .toggle-arrow {
            font-size: 1.2em;
            transition: transform 0.3s ease;
            color: #3d4e9f;
        }

        .genetics-toggle .toggle-arrow.open {
            transform: rotate(180deg);
        }

        .genetics-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 24px;
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease, margin 0.4s ease;
            margin-top: 0;
        }

        .genetics-cards.open {
            max-height: 1200px;
            opacity: 1;
            margin-top: 24px;
        }

        .genetics-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(61, 78, 159, 0.12);
            border-radius: 16px;
            padding: 28px 24px;
            transition: all 0.3s ease;
        }

        .genetics-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(61, 78, 159, 0.15);
            border-color: rgba(61, 78, 159, 0.25);
        }

        .genetics-card .card-icon {
            font-size: 2.4em;
            margin-bottom: 14px;
        }

        .genetics-card h3 {
            color: #3d4e9f;
            font-size: 1.1em;
            line-height: 1.5;
            margin-bottom: 14px;
        }

        .genetics-card .card-teaser {
            color: #555;
            font-size: 0.95em;
            line-height: 1.7;
            margin-bottom: 16px;
        }

        .genetics-card .card-hint {
            color: #7a85c0;
            font-size: 0.85em;
            font-style: italic;
            line-height: 1.6;
            padding-top: 12px;
            border-top: 1px solid rgba(61, 78, 159, 0.08);
        }

        .genetics-card .card-footer {
            color: #9aa2cc;
            font-size: 0.8em;
            margin-top: 12px;
            text-align: right;
        }

        .btn-record {
            background: white;
            color: #3d4e9f;
            border: 2px solid #3d4e9f;
        }

        .btn-record.active {
            background: linear-gradient(135deg, #dc3545 0%, #e85563 100%);
            color: white;
            border-color: #dc3545;
        }

        .recording-badge {
            display: none;
            align-items: center;
            gap: 6px;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: #dc3545;
        }

        .recording-badge.visible {
            display: flex;
        }

        .recording-dot {
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
            animation: pulse 1.2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }

        .name-modal-body {
            padding: 20px 10px;
        }

        .name-modal-body p {
            color: #555;
            margin-bottom: 15px;
            font-size: 1em;
        }

        .name-modal-body input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1.1em;
            outline: none;
            transition: border-color 0.3s;
        }

        .name-modal-body input[type="text"]:focus {
            border-color: #3d4e9f;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: rgba(61, 78, 159, 0.95);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            animation: toastIn 0.4s cubic-bezier(0.4, 0, 0.2, 1), toastOut 0.4s ease-in forwards;
            animation-delay: 0s, var(--toast-duration, 2.5s);
            max-width: 360px;
        }

        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateY(-10px); }
        }

        .footer {
            position: relative;
            background: #3d4e9f;
            color: white;
            text-align: center;
            padding: 10px 20px;
            font-size: 14px;
            margin-top: 30px;
            border-radius: 10px;
            max-width: 1200px;
            width: 90%;
        }
        
        .footer a {
            color: white;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- ì´ˆê¸° ì„ íƒ í™”ë©´ -->
    <div class="selection-screen" id="selectionScreen">
        <h1>ğŸŒ ë‹¬íŒ½ì´ ì§„í™” ì‹œë®¬ë ˆì´ì…˜</h1>
        <p>ì–´ë–¤ í˜•ì§ˆì˜ ì§„í™”ë¥¼ ê´€ì°°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        
        <!-- í™ˆ ë²„íŠ¼ ì„¹ì…˜ ì¶”ê°€ -->
        <div class="home-buttons">
            <button class="home-btn" onclick="showTutorial()">ğŸ“– ì‚¬ìš©ë²•</button>
            <button class="home-btn" onclick="showDevLog()">ğŸ“ ê°œë°œì ë¡œê·¸</button>
        </div>
        
        <div class="scenario-cards">
            <div class="scenario-card speed-card" onclick="openModal('speed')">
                <div class="icon">âš¡</div>
                <h2>ì†ë„ì˜ ì§„í™”</h2>
                <p>í¬ì‹ìë¡œë¶€í„° ë„ë§ì¹˜ëŠ” ì†ë„ê°€ ìƒì¡´ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ê´€ì°°í•©ë‹ˆë‹¤. ë¹ ë¥¸ ë‹¬íŒ½ì´ê°€ ì‚´ì•„ë‚¨ì„ê¹Œìš”?</p>
            </div>
            
            <div class="scenario-card color-card" onclick="openModal('color')">
                <div class="icon">ğŸ¨</div>
                <h2>ìƒ‰ì˜ ì§„í™”</h2>
                <p>í™˜ê²½ê³¼ì˜ ë³´í˜¸ìƒ‰ì´ ìƒì¡´ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ê´€ì°°í•©ë‹ˆë‹¤. ë°°ê²½ê³¼ ë¹„ìŠ·í•œ ìƒ‰ì´ ìœ ë¦¬í• ê¹Œìš”?</p>
            </div>
            
            <div class="scenario-card size-card" onclick="openModal('size')">
                <div class="icon">ğŸ“</div>
                <h2>í¬ê¸°ì˜ ì§„í™”</h2>
                <p>ê°œì²´ì˜ í¬ê¸°ê°€ í¬ì‹ ìœ„í—˜ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ê´€ì°°í•©ë‹ˆë‹¤. ì‘ì€ ê°œì²´ê°€ ë” ì•ˆì „í• ê¹Œìš”?</p>
            </div>
        </div>

        <div class="genetics-section">
            <div class="genetics-toggle" onclick="toggleGenetics()">
                <h2>ğŸ”¬ ì•Œê³  ë³´ë©´ ë†€ë¼ìš´, ë‹¬íŒ½ì´ì˜ ìœ ì „</h2>
                <span class="toggle-arrow" id="geneticsArrow">â–¼</span>
            </div>
            <div class="genetics-cards" id="geneticsCards">
                <div class="genetics-card">
                    <div class="card-icon">ğŸ§¬</div>
                    <h3>ë‹¬íŒ½ì´ëŠ” ì•”ìˆ˜í•œëª¸ì¸ë°, ì™œ í˜¼ì ë²ˆì‹í•˜ì§€ ì•Šì„ê¹Œ?</h3>
                    <div class="card-teaser">
                        ë‹¬íŒ½ì´ëŠ” ì •ìì™€ ë‚œìë¥¼ ëª¨ë‘ ë§Œë“ ë‹¤. ì´ë¡ ìƒ í˜¼ìì„œë„ ë²ˆì‹ì´ ê°€ëŠ¥í•˜ì§€ë§Œ... ê±°ì˜ í•˜ì§€ ì•ŠëŠ”ë‹¤. ì™œì¼ê¹Œ?
                    </div>
                    <div class="card-hint">
                        ğŸ’¡ "ìœ ì „ì  ë‹¤ì–‘ì„±"ì´ë¼ëŠ” í‚¤ì›Œë“œë¡œ ì¡°ì‚¬í•´ë³´ë©´...
                    </div>
                    <div class="card-footer">ì¡°ì‚¬í•´ë³´ë©´ ì¬ë¯¸ìˆì„ì§€ë„...?</div>
                </div>

                <div class="genetics-card">
                    <div class="card-icon">ğŸš</div>
                    <h3>ê»ì§ˆì´ ì™¼ìª½ìœ¼ë¡œ ê°ê¸°ë©´, ì§ì§“ê¸°ë¥¼ ëª» í•œë‹¤?</h3>
                    <div class="card-teaser">
                        ëŒ€ë¶€ë¶„ì˜ ë‹¬íŒ½ì´ ê»ì§ˆì€ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ê°ê¸´ë‹¤. ì™¼ìª½ìœ¼ë¡œ ê°ê¸°ëŠ” ë‹¬íŒ½ì´ëŠ” 4ë§Œ ë§ˆë¦¬ ì¤‘ 1ë§ˆë¦¬. ê·¸ëŸ°ë° ì´ ë‹¬íŒ½ì´ëŠ” ì§ì§“ê¸°ê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ìƒì‹ê¸° ìœ„ì¹˜ê°€ ë°˜ëŒ€ë¼ì„œ.
                    </div>
                    <div class="card-hint">
                        ğŸ’¡ ë” ë†€ë¼ìš´ ê±´, ê»ì§ˆ ë°©í–¥ì„ ê²°ì •í•˜ëŠ” ê±´ ë³¸ì¸ì˜ ìœ ì „ìê°€ ì•„ë‹ˆë¼ <strong>ì–´ë¨¸ë‹ˆì˜ ìœ ì „ì</strong>ë¼ëŠ” ê²ƒ. "ëª¨ì„±ìœ ì „"ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ë©´...
                    </div>
                    <div class="card-footer">ì¡°ì‚¬í•´ë³´ë©´ ì¬ë¯¸ìˆì„ì§€ë„...?</div>
                </div>

                <div class="genetics-card">
                    <div class="card-icon">ğŸ’˜</div>
                    <h3>ë‹¬íŒ½ì´ëŠ” ì§ì§“ê¸° ì „ì— ìƒëŒ€ë°©ì—ê²Œ 'í™”ì‚´'ì„ ìœë‹¤</h3>
                    <div class="card-teaser">
                        ë§ì€ ìœ¡ìƒ ë‹¬íŒ½ì´ëŠ” íƒ„ì‚°ì¹¼ìŠ˜ìœ¼ë¡œ ë§Œë“  ë¾°ì¡±í•œ í™”ì‚´ì„ ê°€ì§€ê³  ìˆë‹¤. ì§ì§“ê¸° ì „ì— ìƒëŒ€ë°© ëª¸ì— ì´ê±¸ ì°”ëŸ¬ ë„£ëŠ”ë‹¤. ì‚¬ë‘ ê³ ë°±? ì•„ë‹ˆë‹¤. í›¨ì”¬ ë” ì´ê¸°ì ì¸ ì´ìœ ê°€ ìˆë‹¤.
                    </div>
                    <div class="card-hint">
                        ğŸ’¡ "love dart snail"ë¡œ ê²€ìƒ‰í•´ë³´ë©´...
                    </div>
                    <div class="card-footer">ì¡°ì‚¬í•´ë³´ë©´ ì¬ë¯¸ìˆì„ì§€ë„...?</div>
                </div>
            </div>
        </div>
    </div>

    <!-- íŠœí† ë¦¬ì–¼ ëª¨ë‹¬ -->
    <div class="modal" id="tutorialModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“– ì‚¬ìš©ë²• ì•ˆë‚´</h3>
                <button class="modal-close" onclick="closeTutorial()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="log-entry">
                    <div class="log-date">ğŸ¯ í”„ë¡œê·¸ë¨ ì†Œê°œ</div>
                    <div class="log-text">
                        <strong>ë‹¬íŒ½ì´ ì§„í™” ì‹œë®¬ë ˆì´ì…˜</strong>ì€ ìì—°ì„ íƒì„ í†µí•œ ì§„í™” ê³¼ì •ì„ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì£¼ëŠ” êµìœ¡ìš© í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤. 
                        ì„¸ ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤(ì†ë„, ë³´í˜¸ìƒ‰, í¬ê¸°)ë¥¼ í†µí•´ íŠ¹ì • í˜•ì§ˆì´ ìƒì¡´ì— ìœ ë¦¬í•  ë•Œ ì§‘ë‹¨ì˜ í‰ê·  í˜•ì§ˆì´ ì–´ë–»ê²Œ ë³€í™”í•˜ëŠ”ì§€ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>

                <div class="log-entry">
                    <div class="log-date">ğŸ“š ê¸°ë³¸ ì‚¬ìš©ë²•</div>
                    <div class="log-text">
                        <strong>1ë‹¨ê³„: ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ</strong><br>
                        â€¢ <strong>ì†ë„ ì§„í™”</strong>: ëŠë¦° ë‹¬íŒ½ì´ê°€ ë¨¼ì € ì¡ì•„ë¨¹í˜<br>
                        â€¢ <strong>ë³´í˜¸ìƒ‰ ì§„í™”</strong>: ë°ì€ ìƒ‰ ë‹¬íŒ½ì´ê°€ ë¨¼ì € ì¡ì•„ë¨¹í˜<br>
                        â€¢ <strong>í¬ê¸° ì§„í™”</strong>: í° ë‹¬íŒ½ì´ê°€ ë¨¼ì € ì¡ì•„ë¨¹í˜<br><br>
                        
                        <strong>2ë‹¨ê³„: ì´ˆê¸° ë¶„í¬ ì„¤ì • (ì„ íƒ)</strong><br>
                        â€¢ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ í›„ ë‚˜íƒ€ë‚˜ëŠ” íŒì—…ì—ì„œ í˜•ì§ˆ ë¶„í¬ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                        â€¢ ë‚®ìŒ/ì¤‘ê°„/ë†’ìŒ í˜•ì§ˆì„ ê°€ì§„ ë‹¬íŒ½ì´ì˜ ê°œì²´ìˆ˜ë¥¼ ì¡°ì ˆí•˜ì„¸ìš”<br>
                        â€¢ "ì‹œì‘í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•©ë‹ˆë‹¤<br><br>
                        
                        <strong>3ë‹¨ê³„: í¬ì‹ì ë°°ì¹˜</strong><br>
                        â€¢ í™”ë©´ì˜ ìº”ë²„ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ í¬ì‹ìë¥¼ ë°°ì¹˜í•˜ì„¸ìš”<br>
                        â€¢ í¬ì‹ìëŠ” ì£¼ë³€ì˜ ë‹¬íŒ½ì´ë¥¼ ì¡ì•„ë¨¹ìŠµë‹ˆë‹¤<br>
                        â€¢ ìƒì¡´ì— ë¶ˆë¦¬í•œ í˜•ì§ˆì„ ê°€ì§„ ë‹¬íŒ½ì´ê°€ ë¨¼ì € ì¡ì•„ë¨¹í™ë‹ˆë‹¤<br><br>
                        
                        <strong>4ë‹¨ê³„: ì„¸ëŒ€ ì§„í–‰ ë° ê´€ì°°</strong><br>
                        â€¢ "ë‹¤ìŒ ì„¸ëŒ€" ë²„íŠ¼ìœ¼ë¡œ ì„¸ëŒ€ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤<br>
                        â€¢ ìƒì¡´í•œ ë‹¬íŒ½ì´ë“¤ì´ ë²ˆì‹í•˜ì—¬ ìƒˆë¡œìš´ ì„¸ëŒ€ê°€ ìƒì„±ë©ë‹ˆë‹¤<br>
                        â€¢ ì˜¤ë¥¸ìª½ í†µê³„ íŒ¨ë„ì—ì„œ ì§‘ë‹¨ì˜ í‰ê·  í˜•ì§ˆ ë³€í™”ë¥¼ í™•ì¸í•˜ì„¸ìš”<br>
                        â€¢ ê·¸ë˜í”„ë¥¼ í†µí•´ ì„¸ëŒ€ë³„ í˜•ì§ˆ ë¶„í¬ ë³€í™”ë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br><br>
                        
                        <strong>5ë‹¨ê³„: ì‹¤í—˜ ì œì–´</strong><br>
                        â€¢ <strong>ì¼ì‹œì •ì§€/ì¬ê°œ</strong>: ì‹œë®¬ë ˆì´ì…˜ì„ ì¼ì‹œ ì¤‘ì§€í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œì‘<br>
                        â€¢ <strong>ì´ˆê¸°í™”</strong>: ì‹œë®¬ë ˆì´ì…˜ì„ ì²˜ìŒ ìƒíƒœë¡œ ë˜ëŒë¦¼<br>
                        â€¢ <strong>ì†ë„ ì¡°ì ˆ</strong>: ìŠ¬ë¼ì´ë”ë¡œ ì‹œë®¬ë ˆì´ì…˜ ì†ë„ ì¡°ì ˆ<br>
                        â€¢ <strong>í†µê³„/ê·¸ë˜í”„ ë³´ê¸°</strong>: ìš°ì¸¡ íŒ¨ë„ ì „í™˜
                    </div>
                </div>

                <div class="log-entry">
                    <div class="log-date">ğŸ’¡ í•™ìŠµ íŒ</div>
                    <div class="log-text">
                        <strong>íš¨ê³¼ì ì¸ ê´€ì°° ë°©ë²•:</strong><br>
                        â€¢ ê° ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰í•˜ì—¬ ì¼ê´€ëœ íŒ¨í„´ì„ í™•ì¸í•˜ì„¸ìš”<br>
                        â€¢ ì´ˆê¸° ë¶„í¬ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •í•˜ì—¬ ê²°ê³¼ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”<br>
                        â€¢ í¬ì‹ìì˜ ìˆ˜ì™€ ë°°ì¹˜ ìœ„ì¹˜ë¥¼ ë‹¬ë¦¬í•˜ë©° ì‹¤í—˜í•˜ì„¸ìš”<br>
                        â€¢ ê·¸ë˜í”„ì—ì„œ ì„¸ëŒ€ê°€ ì§€ë‚ ìˆ˜ë¡ í˜•ì§ˆ ë¶„í¬ê°€ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€ ì£¼ëª©í•˜ì„¸ìš”<br>
                        â€¢ í‰ê· ê°’ì˜ ë³€í™” ì¶”ì´ë¥¼ ê´€ì°°í•˜ì„¸ìš”<br><br>
                        
                        <strong>ì£¼ì˜í•  ì :</strong><br>
                        â€¢ ìì—°ì„ íƒì€ í™•ë¥ ì  ê³¼ì •ì´ë¯€ë¡œ ë§¤ë²ˆ ë˜‘ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                        â€¢ í¬ì‹ ì••ë ¥ì´ ë„ˆë¬´ ê°•í•˜ë©´ ì§‘ë‹¨ì´ ë©¸ì¢…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                        â€¢ ì¶©ë¶„í•œ ì„¸ëŒ€ë¥¼ ì§„í–‰í•´ì•¼ ëª…í™•í•œ ì§„í™” ê²½í–¥ì„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                    </div>
                </div>

                <div class="log-entry">
                    <div class="log-date">ğŸ”¬ ê³¼í•™ì  ë°°ê²½</div>
                    <div class="log-text">
                        ì´ ì‹œë®¬ë ˆì´ì…˜ì€ <strong>ë‹¤ìœˆì˜ ìì—°ì„ íƒ ì´ë¡ </strong>ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. ì§‘ë‹¨ ë‚´ì— ë‹¤ì–‘í•œ í˜•ì§ˆì´ ì¡´ì¬í•˜ê³ , 
                        íŠ¹ì • í˜•ì§ˆì´ ìƒì¡´ê³¼ ë²ˆì‹ì— ìœ ë¦¬í•  ë•Œ, ê·¸ í˜•ì§ˆì„ ê°€ì§„ ê°œì²´ê°€ ë” ë§ì€ ìì†ì„ ë‚¨ê¸°ê²Œ ë©ë‹ˆë‹¤. 
                        ì„¸ëŒ€ê°€ ê±°ë“­ë˜ë©´ì„œ ìœ ë¦¬í•œ í˜•ì§ˆì˜ ë¹ˆë„ê°€ ì¦ê°€í•˜ê³ , ì§‘ë‹¨ì˜ í‰ê·  í˜•ì§ˆì´ ë³€í™”í•©ë‹ˆë‹¤. 
                        ì´ê²ƒì´ ë°”ë¡œ <strong>ì§„í™”</strong>ì…ë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ê°œë°œì ë¡œê·¸ ëª¨ë‹¬ -->
    <div class="modal" id="devLogModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ ê°œë°œì ë¡œê·¸</h3>
                <button class="modal-close" onclick="closeDevLog()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="log-entry">
                    <div class="log-date">2025. 10. 26. (ì¼)</div>
                    <div class="log-text">
                        <strong>ë‹¬íŒ½ì´ ì§„í™” ì‹œë®¬ë ˆì´ì…˜ v1.0 ì¶œì‹œ</strong><br>
                        ìì—°ì„ íƒê³¼ ì§„í™”ë¥¼ ì‹œê°ì ìœ¼ë¡œ ì´í•´í•  ìˆ˜ ìˆëŠ” êµìœ¡ìš© ì‹œë®¬ë ˆì´ì…˜ í”„ë¡œê·¸ë¨ì„ ê³µê°œí–ˆìŠµë‹ˆë‹¤. 
                        ì„¸ ê°€ì§€ ì‹œë‚˜ë¦¬ì˜¤(ì†ë„, ë³´í˜¸ìƒ‰, í¬ê¸°)ë¥¼ í†µí•´ í•™ìƒë“¤ì´ ì§„í™”ì˜ ì›ë¦¬ë¥¼ ì§ì ‘ ì‹¤í—˜í•˜ê³  ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                </div>
                
                <div class="log-entry">
                    <div class="log-date">Â©ï¸ ì €ì‘ê¶Œ ì •ë³´</div>
                    <div class="log-text">
                        <strong>ë‹¬íŒ½ì´ ì§„í™” ì‹œë®¬ë ˆì´ì…˜ v1.0</strong><br><br>
                        â“’ 2025 ì¶©ë‚¨ì‚¼ì„±ê³ ë“±í•™êµ ì‹ ë„ê²½ êµì‚¬<br>
                        ì´ë©”ì¼: <a href="mailto:pantarei01@cnsa.hs.kr">pantarei01@cnsa.hs.kr</a><br><br>
                        
                        ë³¸ í”„ë¡œê·¸ë¨ì€ êµìœ¡ ëª©ì ìœ¼ë¡œ ì œì‘ë˜ì—ˆìœ¼ë©°, ììœ ë¡­ê²Œ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
                        ìƒì—…ì  ì´ìš© ì‹œì—ëŠ” ì œì‘ìì—ê²Œ ë¬¸ì˜í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì´ˆê¸° ì„¤ì • ëª¨ë‹¬ -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">ì´ˆê¸° ê°œì²´êµ° ì„¤ì •</h3>
            
            <div class="distribution-setup">
                <div class="trait-level">
                    <label>
                        <span id="level1Label">ë ˆë²¨ 1</span>
                        <input type="number" id="level1Count" min="0" max="50" value="10">
                    </label>
                </div>
                <div class="trait-level">
                    <label>
                        <span id="level2Label">ë ˆë²¨ 2</span>
                        <input type="number" id="level2Count" min="0" max="50" value="10">
                    </label>
                </div>
                <div class="trait-level">
                    <label>
                        <span id="level3Label">ë ˆë²¨ 3</span>
                        <input type="number" id="level3Count" min="0" max="50" value="10">
                    </label>
                </div>
                <div class="trait-level">
                    <label>
                        <span id="level4Label">ë ˆë²¨ 4</span>
                        <input type="number" id="level4Count" min="0" max="50" value="10">
                    </label>
                </div>
                <div class="trait-level">
                    <label>
                        <span id="level5Label">ë ˆë²¨ 5</span>
                        <input type="number" id="level5Count" min="0" max="50" value="10">
                    </label>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn-start" onclick="startSimulation()">ì‹œì‘í•˜ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal" id="nameModal">
        <div class="modal-content" style="max-width:420px;">
            <div class="modal-header">
                <h3>ğŸ“‹ ê¸°ë¡ëª¨ë“œ</h3>
                <button class="modal-close" onclick="cancelRecording()">Ã—</button>
            </div>
            <div class="name-modal-body">
                <p>ì´ë¦„ ë˜ëŠ” ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                <input type="text" id="studentNameInput" placeholder="ì˜ˆ: í™ê¸¸ë™, 1ë°˜ 3ë²ˆ" maxlength="20">
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="cancelRecording()">ì·¨ì†Œ</button>
                <button class="btn-start" onclick="startRecording()">ê¸°ë¡ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- ì‹œë®¬ë ˆì´ì…˜ í™”ë©´ -->
    <div class="simulation-screen" id="simulationScreen">
        <div class="sim-header">
            <div class="sim-title-section">
                <h2 class="sim-title" id="simTitle">ì†ë„ì˜ ì§„í™”</h2>
                <div class="header-controls">
                    <button class="btn-success" id="startBtn" onclick="toggleSimulation()">â–¶ï¸ ì‹œì‘</button>
                    <button class="btn-warning" id="reproduceBtn" onclick="reproduce()">ğŸ”„ ë²ˆì‹</button>
                    <button class="btn-primary" id="toggleViewBtn" onclick="toggleView()">ğŸ“Š ê·¸ë˜í”„</button>
                    <button class="btn-record" id="recordBtn" onclick="toggleRecording()">ğŸ“‹ ê¸°ë¡ëª¨ë“œ</button>
                </div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
                <div class="recording-badge" id="recordingBadge">
                    <span class="recording-dot"></span>
                    ê¸°ë¡ ì¤‘
                </div>
                <button class="btn-back" onclick="backToSelection()">â—€ ì²˜ìŒìœ¼ë¡œ</button>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-section">
                <h3>âš™ï¸ ì‹œë®¬ë ˆì´ì…˜ ì„¤ì •</h3>
                
                <div class="mode-selector">
                    <div class="mode-button active" id="manualMode" onclick="setMode('manual')">
                        ğŸ‘† ìˆ˜ë™ ëª¨ë“œ
                    </div>
                    <div class="mode-button" id="autoMode" onclick="setMode('auto')">
                        ğŸ¦… ìë™ ëª¨ë“œ
                    </div>
                </div>
                
                <div class="bg-selector" id="bgSelector" style="display: none; margin-top: 10px;">
                    <div class="bg-button grassland active" id="grasslandBg" onclick="setBackground('grassland')">
                        ğŸŒ¿ ì´ˆì§€
                    </div>
                    <div class="bg-button openfield" id="openfieldBg" onclick="setBackground('openfield')">
                        ğŸœï¸ ê°œí™œì§€
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h3>ğŸ§¬ ì§„í™” ì„¤ì •</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="heritableCheck" checked>
                    <label for="heritableCheck">ìœ ì „</label>
                    
                    <input type="checkbox" id="mutationCheck" checked>
                    <label for="mutationCheck">ëŒì—°ë³€ì´</label>
                </div>
                
                <div class="slider-group">
                    <label for="mutationRate">ëŒì—°ë³€ì´ìœ¨:</label>
                    <div class="slider-container">
                        <input type="range" id="mutationRate" min="0" max="20" value="5">
                        <span class="slider-value" id="mutationRateValue">5%</span>
                    </div>
                </div>
            </div>
            
            <div class="control-section">
                <h3>ğŸ® ì»¨íŠ¸ë¡¤</h3>
                
                <div class="slider-group" id="speedControl" style="display: none;">
                    <label for="simSpeed">ì‹œë®¬ë ˆì´ì…˜ ì†ë„:</label>
                    <div class="slider-container">
                        <input type="range" id="simSpeed" min="0.5" max="5" step="0.5" value="1">
                        <span class="slider-value" id="simSpeedValue">1x</span>
                    </div>
                </div>
                
                <button class="btn-danger" onclick="resetSimulation()" style="width: 100%; margin-top: 10px;">â†º ì´ˆê¸°í™”</button>
            </div>
        </div>
        
        <div class="keyboard-hints">âŒ¨ï¸ Space(ì‹œì‘/ì •ì§€) R(ë²ˆì‹) G(ê·¸ë˜í”„) D(ê¸°ë¡) Esc(ì²˜ìŒìœ¼ë¡œ)</div>

        <div class="main-area">
            <canvas id="gameCanvas" width="600" height="400"></canvas>
            
            <div class="stats-panel" id="statsPanel">
                <h3>ğŸ“Š í˜„ì¬ ìƒíƒœ</h3>
                <div class="stat-item">
                    <span class="stat-label">ì´ ê°œì²´ìˆ˜:</span>
                    <span class="stat-value" id="totalCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì„¸ëŒ€:</span>
                    <span class="stat-value" id="generation">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">í‰ê· ê°’:</span>
                    <span class="stat-value" id="avgValue">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ì¡ì€ ê°œì²´ìˆ˜:</span>
                    <span class="stat-value" id="caughtCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ëŒì—°ë³€ì´ ë°œìƒ:</span>
                    <span class="stat-value" id="mutationCount">0</span>
                </div>
                <div class="stat-item" id="eagleStats" style="display: none;">
                    <span class="stat-label">ë…ìˆ˜ë¦¬ ì‚¬ëƒ¥ ì„±ê³µ:</span>
                    <span class="stat-value" id="eagleHunts">0</span>
                </div>
            </div>
            
            <div class="graph-panel" id="graphPanel" style="display: none;">
                <h3>ğŸ“ˆ ë¶„í¬ë„</h3>
                <canvas id="sideChart"></canvas>
            </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        function toggleGenetics() {
            const cards = document.getElementById('geneticsCards');
            const arrow = document.getElementById('geneticsArrow');
            cards.classList.toggle('open');
            arrow.classList.toggle('open');
        }

        function showToast(msg, duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.setProperty('--toast-duration', (duration / 1000) + 's');
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), duration + 500);
        }

        // ì „ì—­ ë³€ìˆ˜
        let currentScenario = '';
        let currentMode = 'manual';
        let currentBackground = 'grassland';
        let snails = [];
        let eagles = [];
        let isRunning = false;
        let generation = 0;
        let caughtCount = 0;
        let mutationCount = 0;
        let animationId = null;
        let initialPopulation = 0;
        let simulationSpeed = 1;
        let backgroundImage = null;
        let sideChart = null;
        let showingGraph = false;
        
        let isRecording = false;
        let recordingData = [];
        let studentName = '';
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbz5Is9wmd4UIsr5WWEs9KiVdkpScfKiYKurT0rUyJxzUEPFz9cO3Qe2H7eDVS96NoiweA/exec';

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // ì‹œë‚˜ë¦¬ì˜¤ë³„ ë ˆì´ë¸”
        const scenarioLabels = {
            speed: {
                title: 'ì†ë„ì˜ ì§„í™”',
                levels: ['ë§¤ìš° ëŠë¦¼', 'ëŠë¦¼', 'ë³´í†µ', 'ë¹ ë¦„', 'ë§¤ìš° ë¹ ë¦„'],
                unit: 'm/s'
            },
            color: {
                title: 'ìƒ‰ì˜ ì§„í™”',
                levels: ['í† ì–‘ìƒ‰', 'ê°ˆìƒ‰', 'ì¤‘ê°„ìƒ‰', 'ì—°ë‘ìƒ‰', 'ì´ˆë¡ìƒ‰'],
                unit: ''
            },
            size: {
                title: 'í¬ê¸°ì˜ ì§„í™”',
                levels: ['ë§¤ìš° ì‘ìŒ', 'ì‘ìŒ', 'ë³´í†µ', 'í¼', 'ë§¤ìš° í¼'],
                unit: 'mm'
            }
        };
        
        // ë‹¬íŒ½ì´ í´ë˜ìŠ¤
        class Snail {
            constructor(level, x, y) {
                this.level = level;
                this.x = x || Math.random() * (canvas.width - 100) + 50;
                this.y = y || Math.random() * (canvas.height - 100) + 50;
                this.angle = Math.random() * Math.PI * 2;
                this.alive = true;
                this.targetAngle = this.angle;
                this.turnSpeed = 0.05;
                this.setupTraits();
            }
            
            setupTraits() {
                if (currentScenario === 'speed') {
                    this.speed = 0.5 + (this.level - 1) * 0.5;
                    this.size = 18;
                    this.colorValue = 0.5;
                } else if (currentScenario === 'color') {
                    this.speed = 1.5;
                    this.size = 18;
                    this.colorValue = (this.level - 1) / 4;
                } else if (currentScenario === 'size') {
                    this.speed = 1.5;
                    this.size = 10 + (this.level - 1) * 4;
                    this.colorValue = 0.5;
                }
            }
            
            getColor() {
                const brown = {r: 139, g: 69, b: 19};
                const green = {r: 76, g: 175, b: 80};
                const r = Math.floor(brown.r + (green.r - brown.r) * this.colorValue);
                const g = Math.floor(brown.g + (green.g - brown.g) * this.colorValue);
                const b = Math.floor(brown.b + (green.b - brown.b) * this.colorValue);
                return `rgb(${r}, ${g}, ${b})`;
            }
            
            update() {
                if (!this.alive || !isRunning) return;
                
                if (Math.random() < 0.02) {
                    this.targetAngle = Math.random() * Math.PI * 2;
                }
                
                const angleDiff = this.targetAngle - this.angle;
                this.angle += angleDiff * this.turnSpeed;
                
                const actualSpeed = this.speed * simulationSpeed;
                this.x += Math.cos(this.angle) * actualSpeed;
                this.y += Math.sin(this.angle) * actualSpeed;
                
                if (this.x < this.size || this.x > canvas.width - this.size) {
                    this.angle = Math.PI - this.angle;
                    this.targetAngle = this.angle;
                    this.x = Math.max(this.size, Math.min(canvas.width - this.size, this.x));
                }
                if (this.y < this.size || this.y > canvas.height - this.size) {
                    this.angle = -this.angle;
                    this.targetAngle = this.angle;
                    this.y = Math.max(this.size, Math.min(canvas.height - this.size, this.y));
                }
            }
            
            draw() {
                if (!this.alive) return;
                
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                // ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
                const shellColor = this.getColor();
                
                // ë‹¬íŒ½ì´ ê»ì§ˆ
                ctx.fillStyle = shellColor;
                ctx.beginPath();
                ctx.arc(0, 0, this.size, 0, Math.PI * 2);
                ctx.fill();
                
                // ë‚˜ì„  ë¬´ëŠ¬
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = 0; i < Math.PI * 4; i += 0.1) {
                    const r = (this.size * 0.8) * (i / (Math.PI * 4));
                    const x = Math.cos(i) * r;
                    const y = Math.sin(i) * r;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.stroke();
                
                // ë‹¬íŒ½ì´ ëª¸ì²´ (ê»ì§ˆê³¼ ê°™ì€ ìƒ‰ìƒ, ì•½ê°„ ë” ì§„í•˜ê²Œ)
                ctx.fillStyle = shellColor;
                ctx.globalAlpha = 0.8;
                ctx.beginPath();
                ctx.ellipse(this.size * 0.8, 0, this.size * 0.6, this.size * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
                
                // ë”ë“¬ì´ (ëª¸ì²´ì™€ ê°™ì€ ìƒ‰ìƒ)
                ctx.strokeStyle = shellColor;
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(this.size * 1.2, -this.size * 0.1);
                ctx.lineTo(this.size * 1.5, -this.size * 0.3);
                ctx.moveTo(this.size * 1.2, this.size * 0.1);
                ctx.lineTo(this.size * 1.5, this.size * 0.3);
                ctx.stroke();
                
                // ëˆˆ (ê²€ì€ìƒ‰ ìœ ì§€)
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(this.size * 1.5, -this.size * 0.3, 2, 0, Math.PI * 2);
                ctx.arc(this.size * 1.5, this.size * 0.3, 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            }
            
            isClicked(x, y) {
                const dist = Math.sqrt((this.x - x) ** 2 + (this.y - y) ** 2);
                return dist <= this.size * 1.5;
            }
            
            getPredationProbability() {
                let probability = 0.1;
                probability += (this.size - 10) / 100;
                probability -= (this.speed - 0.5) / 10;
                
                if (currentScenario === 'color') {
                    const bgIsGreen = currentBackground === 'grassland';
                    const colorDiff = bgIsGreen ? 
                        Math.abs(this.colorValue - 1) : 
                        Math.abs(this.colorValue - 0);
                    probability += colorDiff * 0.5;
                }
                
                return Math.max(0.01, Math.min(0.9, probability));
            }
        }
        
        // ë…ìˆ˜ë¦¬ í´ë˜ìŠ¤
        class Eagle {
            constructor(id = 0) {
                this.id = id;
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = 3;
                this.huntCooldown = 0;
                this.target = null;
                this.hunts = 0;
            }
            
            update() {
                if (!isRunning) return;
                
                this.huntCooldown = Math.max(0, this.huntCooldown - simulationSpeed);
                
                if (!this.target || !this.target.alive || this.huntCooldown > 0) {
                    const aliveSnails = snails.filter(s => s.alive);
                    if (aliveSnails.length > 0 && this.huntCooldown === 0) {
                        const weights = aliveSnails.map(s => s.getPredationProbability());
                        const totalWeight = weights.reduce((a, b) => a + b, 0);
                        
                        let random = Math.random() * totalWeight;
                        for (let i = 0; i < aliveSnails.length; i++) {
                            random -= weights[i];
                            if (random <= 0) {
                                this.target = aliveSnails[i];
                                break;
                            }
                        }
                    }
                }
                
                if (this.target && this.target.alive) {
                    const dx = this.target.x - this.x;
                    const dy = this.target.y - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    this.angle = Math.atan2(dy, dx);
                    
                    const actualSpeed = this.speed * simulationSpeed;
                    
                    if (dist > 5) {
                        this.x += Math.cos(this.angle) * actualSpeed;
                        this.y += Math.sin(this.angle) * actualSpeed;
                    }
                    
                    if (dist < this.target.size + 10) {
                        this.target.alive = false;
                        this.target = null;
                        this.huntCooldown = 60 / simulationSpeed;
                        this.hunts++;
                        caughtCount++;
                        updateStats();
                        updateChart();
                        checkReproductionReady();
                    }
                } else {
                    this.angle += (Math.random() - 0.5) * 0.1;
                    const actualSpeed = this.speed * simulationSpeed * 0.5;
                    this.x += Math.cos(this.angle) * actualSpeed;
                    this.y += Math.sin(this.angle) * actualSpeed;
                    
                    if (this.x < 50) this.x = 50;
                    if (this.x > canvas.width - 50) this.x = canvas.width - 50;
                    if (this.y < 50) this.y = 50;
                    if (this.y > canvas.height - 50) this.y = canvas.height - 50;
                }
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                // ë…ìˆ˜ë¦¬ ê·¸ë¦¼ì (ìœ„ì—ì„œ ë³¸ ì‹¤ë£¨ì—£)
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                
                // ìŠ¤ì¼€ì¼ ì¡°ì •
                ctx.scale(1.2, 1.2);
                
                // ëª¸í†µ
                ctx.beginPath();
                ctx.ellipse(0, 0, 8, 12, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // ë¨¸ë¦¬
                ctx.beginPath();
                ctx.arc(0, -10, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // ì™¼ìª½ ë‚ ê°œ (í¼ì¹œ ëª¨ì–‘)
                ctx.beginPath();
                ctx.moveTo(-5, -5);
                // ë‚ ê°œ ì•ë¶€ë¶„
                ctx.quadraticCurveTo(-20, -8, -30, -5);
                // ë‚ ê°œ ë ê¹ƒí„¸ë“¤
                ctx.lineTo(-32, -2);
                ctx.lineTo(-33, 1);
                ctx.lineTo(-32, 4);
                ctx.lineTo(-30, 6);
                ctx.lineTo(-27, 7);
                // ë‚ ê°œ ë’·ë¶€ë¶„
                ctx.quadraticCurveTo(-20, 6, -15, 8);
                ctx.quadraticCurveTo(-10, 10, -5, 8);
                ctx.closePath();
                ctx.fill();
                
                // ì˜¤ë¥¸ìª½ ë‚ ê°œ (í¼ì¹œ ëª¨ì–‘)
                ctx.beginPath();
                ctx.moveTo(5, -5);
                // ë‚ ê°œ ì•ë¶€ë¶„
                ctx.quadraticCurveTo(20, -8, 30, -5);
                // ë‚ ê°œ ë ê¹ƒí„¸ë“¤
                ctx.lineTo(32, -2);
                ctx.lineTo(33, 1);
                ctx.lineTo(32, 4);
                ctx.lineTo(30, 6);
                ctx.lineTo(27, 7);
                // ë‚ ê°œ ë’·ë¶€ë¶„
                ctx.quadraticCurveTo(20, 6, 15, 8);
                ctx.quadraticCurveTo(10, 10, 5, 8);
                ctx.closePath();
                ctx.fill();
                
                // ê¼¬ë¦¬ (ë¶€ì±„ê¼´ ëª¨ì–‘)
                ctx.beginPath();
                ctx.moveTo(-4, 10);
                ctx.quadraticCurveTo(-3, 15, -5, 18);
                ctx.lineTo(-3, 19);
                ctx.lineTo(-1, 20);
                ctx.lineTo(0, 20);
                ctx.lineTo(1, 20);
                ctx.lineTo(3, 19);
                ctx.lineTo(5, 18);
                ctx.quadraticCurveTo(3, 15, 4, 10);
                ctx.closePath();
                ctx.fill();
                
                ctx.restore();
            }
        }
        // ëª¨ë‹¬ í•¨ìˆ˜ë“¤ ì¶”ê°€ (ê¸°ì¡´ ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ ì•„ë˜ì— ì¶”ê°€)

// íŠœí† ë¦¬ì–¼ ëª¨ë‹¬
function showTutorial() {
    document.getElementById('tutorialModal').style.display = 'block';
}

function closeTutorial() {
    document.getElementById('tutorialModal').style.display = 'none';
}

// ê°œë°œì ë¡œê·¸ ëª¨ë‹¬
function showDevLog() {
    document.getElementById('devLogModal').style.display = 'block';
}

function closeDevLog() {
    document.getElementById('devLogModal').style.display = 'none';
}

function captureSnapshot() {
    const aliveSnails = snails.filter(s => s.alive);
    const counts = [0, 0, 0, 0, 0];
    aliveSnails.forEach(s => { counts[s.level - 1]++; });
    const total = aliveSnails.length;

    let avg = 0;
    if (total > 0) {
        if (currentScenario === 'speed') {
            avg = aliveSnails.reduce((sum, s) => sum + s.speed, 0) / total;
        } else if (currentScenario === 'color') {
            avg = aliveSnails.reduce((sum, s) => sum + s.level, 0) / total;
        } else if (currentScenario === 'size') {
            avg = aliveSnails.reduce((sum, s) => sum + s.size, 0) / total;
        }
    }

    return {
        gen: generation,
        lv1: counts[0], lv2: counts[1], lv3: counts[2], lv4: counts[3], lv5: counts[4],
        total: total,
        avg: Math.round(avg * 100) / 100,
        mutations: mutationCount
    };
}

function toggleRecording() {
    if (!isRecording) {
        document.getElementById('nameModal').style.display = 'block';
        document.getElementById('studentNameInput').value = '';
        setTimeout(() => document.getElementById('studentNameInput').focus(), 100);
    } else {
        stopRecording();
    }
}

function startRecording() {
    const nameInput = document.getElementById('studentNameInput').value.trim();
    if (!nameInput) {
        showToast('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
        return;
    }
    studentName = nameInput;
    isRecording = true;
    recordingData = [];

    document.getElementById('nameModal').style.display = 'none';
    document.getElementById('recordBtn').classList.add('active');
    document.getElementById('recordBtn').textContent = 'â¹ ê¸°ë¡ì¤‘ì§€';
    document.getElementById('recordingBadge').classList.add('visible');

    recordingData.push(captureSnapshot());
    showToast('ê¸°ë¡ëª¨ë“œ ì‹œì‘! ì„¸ëŒ€ë³„ ë°ì´í„°ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.', 3000);
}

function cancelRecording() {
    document.getElementById('nameModal').style.display = 'none';
}

function stopRecording() {
    isRecording = false;
    document.getElementById('recordBtn').classList.remove('active');
    document.getElementById('recordBtn').textContent = 'ğŸ“‹ ê¸°ë¡ëª¨ë“œ';
    document.getElementById('recordingBadge').classList.remove('visible');

    if (recordingData.length <= 1) {
        showToast('ê¸°ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ë²ˆì‹ì„ 1íšŒ ì´ìƒ ì§„í–‰í•´ì£¼ì„¸ìš”)', 3000);
        recordingData = [];
        return;
    }

    sendRecordingData();
}

function sendRecordingData() {
    showToast('ì „ì†¡ ì¤‘...', 5000);

    const payload = {
        studentName: studentName,
        scenario: currentScenario,
        data: recordingData
    };

    fetch(GAS_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        mode: 'no-cors'
    })
    .then(function() {
        showToast('ê¸°ë¡ ì™„ë£Œ! ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 4000);
        recordingData = [];
    })
    .catch(function(err) {
        showToast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜! CSVë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.', 4000);
        downloadCSV();
        recordingData = [];
    });
}

function downloadCSV() {
    const headers = 'ì„¸ëŒ€,Lv1,Lv2,Lv3,Lv4,Lv5,ì´ ê°œì²´ìˆ˜,í‰ê· ê°’,ëŒì—°ë³€ì´\n';
    const rows = recordingData.map(function(d) {
        return [d.gen, d.lv1, d.lv2, d.lv3, d.lv4, d.lv5, d.total, d.avg, d.mutations].join(',');
    }).join('\n');

    const bom = '\uFEFF';
    const blob = new Blob([bom + headers + rows], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = studentName + '_' + currentScenario + '_ê¸°ë¡.csv';
    a.click();
    URL.revokeObjectURL(url);
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
window.onclick = function(event) {
    const tutorialModal = document.getElementById('tutorialModal');
    const devLogModal = document.getElementById('devLogModal');
    const setupModal = document.getElementById('setupModal');
    const nameModal = document.getElementById('nameModal');

    if (event.target === tutorialModal) {
        tutorialModal.style.display = 'none';
    }
    if (event.target === devLogModal) {
        devLogModal.style.display = 'none';
    }
    if (event.target === setupModal) {
        setupModal.style.display = 'none';
    }
    if (event.target === nameModal) {
        nameModal.style.display = 'none';
    }
}
        // ëª¨ë‹¬ ì—´ê¸°
        function openModal(scenario) {
            currentScenario = scenario;
            const modal = document.getElementById('setupModal');
            const labels = scenarioLabels[scenario];
            
            document.getElementById('modalTitle').textContent = `${labels.title} - ì´ˆê¸° ê°œì²´êµ° ì„¤ì •`;
            
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`level${i}Label`).textContent = labels.levels[i-1];
            }
            
            modal.style.display = 'block';
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('setupModal').style.display = 'none';
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
        function startSimulation() {
            const levelCounts = [];
            for (let i = 1; i <= 5; i++) {
                levelCounts.push(parseInt(document.getElementById(`level${i}Count`).value) || 0);
            }
            
            initialPopulation = levelCounts.reduce((a, b) => a + b, 0);
            
            if (initialPopulation === 0) {
                showToast('ìµœì†Œ 1ë§ˆë¦¬ ì´ìƒì˜ ë‹¬íŒ½ì´ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            snails = [];
            for (let level = 1; level <= 5; level++) {
                for (let i = 0; i < levelCounts[level-1]; i++) {
                    snails.push(new Snail(level));
                }
            }
            
            document.getElementById('setupModal').style.display = 'none';
            document.getElementById('selectionScreen').style.display = 'none';
            document.getElementById('simulationScreen').style.display = 'block';
            document.getElementById('simulationScreen').classList.add('active');
            
            const labels = scenarioLabels[currentScenario];
            document.getElementById('simTitle').textContent = labels.title;
            
            if (currentScenario === 'color') {
                document.getElementById('bgSelector').style.display = 'grid';
            } else {
                document.getElementById('bgSelector').style.display = 'none';
            }
            
            generation = 0;
            caughtCount = 0;
            mutationCount = 0;
            eagles = [];
            simulationSpeed = 1;
            
            document.getElementById('reproduceBtn').disabled = true;
            
            updateStats();
            initChart();
            updateChart();
            requestAnimationFrame(() => {
                resizeCanvas();
            });
        }
        
        // ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
        function backToSelection() {
            if (isRecording) {
                stopRecording();
            }
            if (isRunning) {
                toggleSimulation();
            }
            
            document.getElementById('simulationScreen').style.display = 'none';
            document.getElementById('simulationScreen').classList.remove('active');
            document.getElementById('selectionScreen').style.display = 'block';
            
            // ê·¸ë˜í”„ ì´ˆê¸°í™”
            if (sideChart) {
                sideChart.destroy();
                sideChart = null;
            }
            
            // ë·° ìƒíƒœ ì´ˆê¸°í™”
            showingGraph = false;
            document.getElementById('toggleViewBtn').innerHTML = 'ğŸ“Š ê·¸ë˜í”„';
            document.getElementById('statsPanel').style.display = 'block';
            document.getElementById('graphPanel').style.display = 'none';
            
            // ê°œì²´ìˆ˜ ì…ë ¥ ì´ˆê¸°í™”
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`level${i}Count`).value = 10;
            }
            
            // ëª¨ë“œ ì´ˆê¸°í™” (ìˆ˜ë™ ëª¨ë“œë¡œ)
            currentMode = 'manual';
            document.getElementById('manualMode').classList.add('active');
            document.getElementById('autoMode').classList.remove('active');
            eagles = [];
            document.getElementById('eagleStats').style.display = 'none';
            document.getElementById('speedControl').style.display = 'none';
            
            // ë°°ê²½ ì´ˆê¸°í™” (ì´ˆì§€ë¡œ)
            currentBackground = 'grassland';
            document.getElementById('grasslandBg').classList.add('active');
            document.getElementById('openfieldBg').classList.remove('active');
            backgroundImage = null;
            
            // ì²´í¬ë°•ìŠ¤ ì´ˆê¸°í™”
            document.getElementById('heritableCheck').checked = true;
            document.getElementById('mutationCheck').checked = true;
            
            // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
            document.getElementById('mutationRate').value = 5;
            document.getElementById('mutationRateValue').textContent = '5%';
            document.getElementById('simSpeed').value = 1;
            document.getElementById('simSpeedValue').textContent = '1x';
            simulationSpeed = 1;
            
            // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            document.getElementById('startBtn').textContent = 'â–¶ï¸ ì‹œì‘';
            document.getElementById('startBtn').className = 'btn-success';
            document.getElementById('reproduceBtn').disabled = true;
            
            // ë³€ìˆ˜ ì´ˆê¸°í™”
            snails = [];
            generation = 0;
            caughtCount = 0;
            mutationCount = 0;
            isRunning = false;
            
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }
        
        // ë°°ê²½ ìƒì„±
        function createBackgroundImage() {
            const offCanvas = document.createElement('canvas');
            offCanvas.width = canvas.width;
            offCanvas.height = canvas.height;
            const offCtx = offCanvas.getContext('2d');
            
            if (currentBackground === 'grassland') {
                const gradient = offCtx.createLinearGradient(0, 0, 0, offCanvas.height);
                gradient.addColorStop(0, '#8BC34A');
                gradient.addColorStop(1, '#4CAF50');
                offCtx.fillStyle = gradient;
                offCtx.fillRect(0, 0, offCanvas.width, offCanvas.height);
                
                offCtx.strokeStyle = 'rgba(76, 175, 80, 0.6)';
                offCtx.lineWidth = 2;
                for (let i = 0; i < 150; i++) {
                    const x = Math.random() * offCanvas.width;
                    const y = Math.random() * offCanvas.height;
                    
                    offCtx.beginPath();
                    const blades = Math.floor(Math.random() * 3) + 3;
                    for (let j = 0; j < blades; j++) {
                        const angle = (Math.PI / 4) * (j / blades - 0.5);
                        const height = Math.random() * 15 + 10;
                        offCtx.moveTo(x, y);
                        offCtx.quadraticCurveTo(
                            x + Math.sin(angle) * height/2, 
                            y - height/2,
                            x + Math.sin(angle) * height, 
                            y - height
                        );
                    }
                    offCtx.stroke();
                }
            } else {
                offCtx.fillStyle = '#8B4513';
                offCtx.fillRect(0, 0, offCanvas.width, offCanvas.height);
                
                for (let i = 0; i < 80; i++) {
                    const x = Math.random() * offCanvas.width;
                    const y = Math.random() * offCanvas.height;
                    const size = Math.random() * 3 + 1;
                    
                    offCtx.fillStyle = `rgba(101, 67, 33, ${Math.random() * 0.5 + 0.2})`;
                    offCtx.beginPath();
                    offCtx.arc(x, y, size, 0, Math.PI * 2);
                    offCtx.fill();
                }
                
                offCtx.fillStyle = 'rgba(139, 90, 43, 0.4)';
                for (let i = 0; i < 30; i++) {
                    const x = Math.random() * offCanvas.width;
                    const y = Math.random() * offCanvas.height;
                    offCtx.beginPath();
                    offCtx.ellipse(x, y, Math.random() * 8 + 3, Math.random() * 5 + 2, Math.random() * Math.PI, 0, Math.PI * 2);
                    offCtx.fill();
                }
            }
            
            backgroundImage = offCanvas;
        }
        
        function drawBackground() {
            if (!backgroundImage) {
                createBackgroundImage();
            }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(backgroundImage, 0, 0);
        }
        
        // ëª¨ë“œ ì„¤ì •
        function setMode(mode) {
            currentMode = mode;
            
            document.getElementById('manualMode').classList.toggle('active', mode === 'manual');
            document.getElementById('autoMode').classList.toggle('active', mode === 'auto');
            
            if (mode === 'auto') {
                eagles = [new Eagle(0), new Eagle(1)];
                document.getElementById('eagleStats').style.display = 'flex';
                document.getElementById('speedControl').style.display = 'block';
            } else {
                eagles = [];
                document.getElementById('eagleStats').style.display = 'none';
                document.getElementById('speedControl').style.display = 'none';
            }
        }
        
        // ë°°ê²½ ì„¤ì •
        function setBackground(bg) {
            currentBackground = bg;
            
            document.getElementById('grasslandBg').classList.toggle('active', bg === 'grassland');
            document.getElementById('openfieldBg').classList.toggle('active', bg === 'openfield');
            
            backgroundImage = null;
            drawBackground();
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ í† ê¸€
        function toggleSimulation() {
            isRunning = !isRunning;
            const btn = document.getElementById('startBtn');
            
            if (isRunning) {
                btn.textContent = 'â¸ï¸ ì •ì§€';
                btn.className = 'btn-danger';
                document.getElementById('reproduceBtn').disabled = true;
                animate();
            } else {
                btn.textContent = 'â–¶ï¸ ì‹œì‘';
                btn.className = 'btn-success';
                document.getElementById('reproduceBtn').disabled = false;
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            }
        }
        
        // ì• ë‹ˆë©”ì´ì…˜
        function animate() {
            if (!isRunning) return;
            
            drawBackground();
            
            snails.forEach(snail => {
                snail.update();
                snail.draw();
            });
            
            eagles.forEach(eagle => {
                eagle.update();
                eagle.draw();
            });
            
            if (eagles.length > 0) {
                const totalHunts = eagles.reduce((sum, e) => sum + e.hunts, 0);
                document.getElementById('eagleHunts').textContent = totalHunts;
            }
            
            animationId = requestAnimationFrame(animate);
        }
        
        // ë²ˆì‹ ê°€ëŠ¥ ì²´í¬
        function checkReproductionReady() {
            const aliveCount = snails.filter(s => s.alive).length;
            const halfPopulation = Math.floor(initialPopulation / 2);
            
            // ìë™ ëª¨ë“œì—ì„œë§Œ ì ˆë°˜ì—ì„œ ì •ì§€
            if (currentMode === 'auto' && aliveCount <= halfPopulation) {
                // ìë™ ëª¨ë“œ: ì ˆë°˜ ì´í•˜ê°€ ë˜ë©´ ìë™ ì •ì§€
                isRunning = false;
                document.getElementById('startBtn').textContent = 'â–¶ï¸ ì‹œì‘';
                document.getElementById('startBtn').className = 'btn-success';
                document.getElementById('reproduceBtn').disabled = false;
                
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                showToast(`ê°œì²´ìˆ˜ê°€ ì ˆë°˜(${halfPopulation}ë§ˆë¦¬) ì´í•˜! ë²ˆì‹ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`, 4000);
            }
            // ìˆ˜ë™ ëª¨ë“œì—ì„œëŠ” ì •ì§€í•˜ì§€ ì•ŠìŒ
        }
        
        // ë²ˆì‹
        function reproduce() {
            const aliveSnails = snails.filter(s => s.alive);
            
            if (aliveSnails.length === 0) {
                showToast('ì‚´ì•„ìˆëŠ” ê°œì²´ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            const isHeritable = document.getElementById('heritableCheck').checked;
            const isMutation = document.getElementById('mutationCheck').checked;
            const mutationRate = document.getElementById('mutationRate').value / 100;
            
            const newSnails = [];
            let mutationOccurred = 0; // ì´ë²ˆ ë²ˆì‹ì—ì„œ ë°œìƒí•œ ëŒì—°ë³€ì´ ìˆ˜
            
            aliveSnails.forEach(parent => {
                parent.alive = true;
                newSnails.push(parent);
                
                let childLevel = parent.level;
                
                if (isHeritable) {
                    if (isMutation) {
                        // ê° ìì†ë§ˆë‹¤ ëŒì—°ë³€ì´ í™•ë¥  ê³„ì‚°
                        const randomValue = Math.random();
                        if (randomValue < mutationRate) {
                            mutationOccurred++;
                            
                            // ëŒì—°ë³€ì´ ê°•ë„ë¥¼ ë‹¤ì–‘í•˜ê²Œ
                            const mutationStrength = Math.random();
                            let change;
                            
                            if (mutationStrength < 0.7) {
                                // 70% í™•ë¥ ë¡œ Â±1 ë³€í™”
                                change = Math.random() < 0.5 ? -1 : 1;
                            } else if (mutationStrength < 0.95) {
                                // 25% í™•ë¥ ë¡œ Â±2 ë³€í™”
                                change = Math.random() < 0.5 ? -2 : 2;
                            } else {
                                // 5% í™•ë¥ ë¡œ Â±3 ë³€í™” (í° ëŒì—°ë³€ì´)
                                change = Math.random() < 0.5 ? -3 : 3;
                            }
                            
                            childLevel = Math.max(1, Math.min(5, parent.level + change));
                        }
                    }
                } else {
                    childLevel = Math.floor(Math.random() * 5) + 1;
                }
                
                const angle = Math.random() * Math.PI * 2;
                const distance = parent.size + 25;
                const childX = parent.x + Math.cos(angle) * distance;
                const childY = parent.y + Math.sin(angle) * distance;
                
                const x = Math.max(30, Math.min(canvas.width - 30, childX));
                const y = Math.max(30, Math.min(canvas.height - 30, childY));
                
                const child = new Snail(childLevel, x, y);
                child.alive = true;
                newSnails.push(child);
            });
            
            snails = newSnails.filter(s => s.alive);
            generation++;
            caughtCount = 0;
            mutationCount += mutationOccurred; // ëˆ„ì  ëŒì—°ë³€ì´ ìˆ˜ ì—…ë°ì´íŠ¸
            
            eagles.forEach(eagle => {
                eagle.hunts = 0;
            });
            
            document.getElementById('reproduceBtn').disabled = false;
            
            updateStats();
            updateChart();

            if (isRecording) {
                recordingData.push(captureSnapshot());
            }

            if (!isRunning) {
                drawBackground();
                snails.forEach(snail => {
                    if (snail.alive) {
                        snail.draw();
                    }
                });
            }
        }
        
        // ì´ˆê¸°í™”
        function resetSimulation() {
            isRunning = false;
            document.getElementById('startBtn').textContent = 'â–¶ï¸ ì‹œì‘';
            document.getElementById('startBtn').className = 'btn-success';
            document.getElementById('reproduceBtn').disabled = true;
            
            snails = [];
            for (let level = 1; level <= 5; level++) {
                const count = parseInt(document.getElementById(`level${level}Count`).value) || 0;
                for (let i = 0; i < count; i++) {
                    snails.push(new Snail(level));
                }
            }
            
            generation = 0;
            caughtCount = 0;
            mutationCount = 0;
            
            eagles.forEach((eagle, index) => {
                eagles[index] = new Eagle(index);
            });
            
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            
            updateStats();
            updateChart();
            drawBackground();
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            const aliveSnails = snails.filter(s => s.alive);
            
            document.getElementById('totalCount').textContent = aliveSnails.length;
            document.getElementById('generation').textContent = generation;
            document.getElementById('caughtCount').textContent = caughtCount;
            document.getElementById('mutationCount').textContent = mutationCount;
            
            if (aliveSnails.length > 0) {
                let avgValue = 0;
                
                if (currentScenario === 'speed') {
                    avgValue = aliveSnails.reduce((sum, s) => sum + s.speed, 0) / aliveSnails.length;
                    document.getElementById('avgValue').textContent = avgValue.toFixed(2) + ' m/s';
                } else if (currentScenario === 'color') {
                    avgValue = aliveSnails.reduce((sum, s) => sum + s.level, 0) / aliveSnails.length;
                    document.getElementById('avgValue').textContent = avgValue.toFixed(1) + ' ë ˆë²¨';
                } else if (currentScenario === 'size') {
                    avgValue = aliveSnails.reduce((sum, s) => sum + s.size, 0) / aliveSnails.length;
                    document.getElementById('avgValue').textContent = avgValue.toFixed(1) + ' mm';
                }
            } else {
                document.getElementById('avgValue').textContent = '0';
            }
        }
        
        // ë·° í† ê¸€ (í†µê³„ <-> ê·¸ë˜í”„)
        function toggleView() {
            showingGraph = !showingGraph;
            const btn = document.getElementById('toggleViewBtn');
            const statsPanel = document.getElementById('statsPanel');
            const graphPanel = document.getElementById('graphPanel');
            
            if (showingGraph) {
                statsPanel.style.display = 'none';
                graphPanel.style.display = 'block';
                btn.innerHTML = 'ğŸ“Š ì¸ë±ìŠ¤';
                
                // ê·¸ë˜í”„ê°€ ì—†ìœ¼ë©´ ìƒì„±
                if (!sideChart) {
                    initSideChart();
                }
                updateChart();
            } else {
                statsPanel.style.display = 'block';
                graphPanel.style.display = 'none';
                btn.innerHTML = 'ğŸ“Š ê·¸ë˜í”„';
            }
        }
        
        // ì‚¬ì´ë“œ ì°¨íŠ¸ ì´ˆê¸°í™”
        function initSideChart() {
            const ctx = document.getElementById('sideChart').getContext('2d');
            const labels = scenarioLabels[currentScenario];
            
            sideChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.levels,
                    datasets: [{
                        label: 'ê°œì²´ìˆ˜',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.5)',
                            'rgba(255, 159, 64, 0.5)',
                            'rgba(255, 205, 86, 0.5)',
                            'rgba(75, 192, 192, 0.5)',
                            'rgba(54, 162, 235, 0.5)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 205, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            // ì‚¬ì´ë“œ ì°¨íŠ¸ëŠ” toggleViewì—ì„œ ì²˜ë¦¬
        }
        
        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateChart() {
            if (sideChart && showingGraph) {
                const counts = [0, 0, 0, 0, 0];
                const aliveSnails = snails.filter(s => s.alive);
                
                aliveSnails.forEach(s => {
                    counts[s.level - 1]++;
                });
                
                sideChart.data.datasets[0].data = counts;
                sideChart.update();
            }
        }
        
        // í´ë¦­ ì´ë²¤íŠ¸
        canvas.addEventListener('click', (e) => {
            if (!isRunning || currentMode !== 'manual') return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            for (let i = snails.length - 1; i >= 0; i--) {
                const snail = snails[i];
                if (snail.alive && snail.isClicked(x, y)) {
                    snail.alive = false;
                    caughtCount++;
                    updateStats();
                    updateChart();
                    checkReproductionReady();
                    break;
                }
            }
        });
        
        // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        document.getElementById('mutationRate').addEventListener('input', (e) => {
            document.getElementById('mutationRateValue').textContent = e.target.value + '%';
        });
        
        document.getElementById('simSpeed').addEventListener('input', (e) => {
            simulationSpeed = parseFloat(e.target.value);
            document.getElementById('simSpeedValue').textContent = simulationSpeed + 'x';
        });
        
        let resizeTimer;
        function resizeCanvas() {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            const oldWidth = canvas.width;
            const oldHeight = canvas.height;
            const newWidth = containerWidth;
            const newHeight = Math.round(containerWidth * 2 / 3);

            canvas.width = newWidth;
            canvas.height = newHeight;

            const scaleX = newWidth / oldWidth;
            const scaleY = newHeight / oldHeight;
            snails.forEach(s => {
                s.x *= scaleX;
                s.y *= scaleY;
            });
            eagles.forEach(e => {
                e.x *= scaleX;
                e.y *= scaleY;
            });

            backgroundImage = null;
            drawBackground();
            snails.forEach(s => { if (s.alive) s.draw(); });
            eagles.forEach(e => e.draw());
        }

        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                if (document.getElementById('simulationScreen').classList.contains('active')) {
                    resizeCanvas();
                }
            }, 150);
        });

        document.getElementById('studentNameInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                startRecording();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return;
            if (!document.getElementById('simulationScreen').classList.contains('active')) return;

            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    toggleSimulation();
                    showToast(isRunning ? 'â–¶ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘' : 'â¸ ì¼ì‹œì •ì§€', 1500);
                    break;
                case 'KeyR':
                    if (!document.getElementById('reproduceBtn').disabled) {
                        reproduce();
                        showToast(`ğŸ”„ ${generation}ì„¸ëŒ€ ë²ˆì‹ ì™„ë£Œ`, 1500);
                    }
                    break;
                case 'KeyG':
                    toggleView();
                    break;
                case 'KeyD':
                    toggleRecording();
                    break;
                case 'Escape':
                    backToSelection();
                    break;
            }
        });
    </script>
    
    <!-- Footer ì—¬ê¸°ì— ì¶”ê°€ -->
    <div class="footer">
        â“’ 2025 ì¶©ë‚¨ì‚¼ì„±ê³ ë“±í•™êµ ì‹ ë„ê²½T<br>
        <a href="mailto:pantarei01@cnsa.hs.kr">pantarei01@cnsa.hs.kr</a>
    </div>

</body>
</html>
